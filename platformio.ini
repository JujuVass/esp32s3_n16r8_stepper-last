; PlatformIO Project Configuration File
; ESP32-S3 WROOM-1 N16R8 (16MB Flash + 8MB OPI PSRAM)

[platformio]
default_envs = esp32s3_n16r8, esp32s3_usb
extra_configs = secrets.ini  ; OTA credentials (gitignored)

; ============================================================================
; ESP32 COMMON CONFIGURATION (shared by all ESP32 environments)
; ============================================================================
[esp32_common]
platform = https://github.com/pioarduino/platform-espressif32/releases/download/55.03.37/platform-espressif32.zip
board = esp32-s3-devkitc-1
framework = arduino

; ============================================================================
; BOARD CONFIGURATION: ESP32-S3 WROOM-1 N16R8
; ============================================================================
; Hardware: ESP32-S3 WROOM-1 (16MB Flash + 8MB OPI PSRAM)
; 
; Pin mapping (via Level Shifter J1Y/BSS138):
;   GPIO 6  = PIN_PULSE (PU-)
;   GPIO 7  = PIN_DIR (DR-)
;   GPIO 15 = PIN_ENABLE (EN-)
;   GPIO 16 = PIN_PEND (PED- input)
;   GPIO 17 = PIN_ALM (ALM- input)
;   GPIO 5  = PIN_START_CONTACT (MIN - capteur opto jaune)
;   GPIO 4  = PIN_END_CONTACT (MAX - capteur opto vert)
;   GPIO 19 = PIN_AP_MODE (GND = normal, floating = AP_SETUP)
; ============================================================================

; MCU configuration
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L

; ============================================================================
; ESP32-S3 N16R8 Configuration: 16MB Flash + 8MB OPI PSRAM
; ============================================================================
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.partitions = default_16MB.csv
board_build.arduino.memory_type = qio_opi

; PSRAM OPI (Octal, not Quad!)
board_build.arduino.psram_type = opi

; Filesystem
board_build.filesystem = littlefs

board_upload.flash_size = 16MB
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; ============================================================================
; BUILD FLAGS
; ============================================================================
build_flags = 
    -D CORE_DEBUG_LEVEL=3
    -D BOARD_HAS_PSRAM
    -D ARDUINO_ESP32S3_DEV
    -ffunction-sections
    -fdata-sections
    -D CONFIG_LWIP_MAX_SOCKETS=16
    -D ARDUINOJSON_ENABLE_PROGMEM=1
    -D CONFIG_ARDUHAL_LOG_COLORS=1
    -D ARDUINOJSON_USE_DOUBLE=0
    -Wno-deprecated-declarations  ; Suppress WebSockets 2.7.3 flush() deprecation (no newer version available)


; Libraries
lib_deps = 
    links2004/WebSockets@^2.7.1
    bblanchon/ArduinoJson@^7.4.2

; ============================================================================
; OTA WIFI UPLOAD ENVIRONMENT (default - production)
; ============================================================================
; OTA upload_flags (--port + --auth) are in secrets.ini (gitignored)
; See secrets.ini.example for setup
; ============================================================================
[env:esp32s3_n16r8]
extends = esp32_common
upload_protocol = espota
upload_port = 192.168.1.85

; ============================================================================
; USB UPLOAD ENVIRONMENT (for first flash or recovery)
; ============================================================================
; Usage: pio run -e esp32s3_usb -t upload
; ============================================================================
[env:esp32s3_usb]
extends = esp32_common
upload_protocol = esptool

; ============================================================================
; NATIVE TEST ENVIRONMENT (runs on host PC, no ESP32 needed)
; ============================================================================
; Usage: pio test -e native
; Tests: Config constants, Type defaults, Speed math, Zone curves,
;        Chaos patterns, Validators, Stats tracking
; ============================================================================
[env:native]
platform = native
test_framework = unity
platform_packages =
    toolchain-gccmingw32
build_flags = 
    -std=c++20
    -Itest/test_native/stubs
    -Iinclude