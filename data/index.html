<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stepper Controller</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš™ï¸</text></svg>">

  <!-- Note: Preloads removed - they cause issues with slow mDNS resolution -->
  <!-- Scripts are loaded sequentially at end of body for reliability -->

  <link rel="stylesheet" href="/css/styles.css">
  <!-- chart.umd.min.js loaded by sequential loader below -->
</head>
<body>
  <!-- Script Loading Overlay (shown during sequential JS load) -->
  <div id="scriptLoadOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(145deg,#0f172a,#1e293b,#1a1a2e);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;font-family:'Segoe UI',system-ui,sans-serif;">
    <div style="font-size:52px;margin-bottom:24px;filter:drop-shadow(0 0 12px rgba(102,126,234,0.4));">âš™ï¸</div>
    <div style="width:240px;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;margin-bottom:14px;">
      <div id="scriptLoadBar" style="width:0%;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;border-radius:3px;"></div>
    </div>
    <div id="scriptLoadText" style="font-size:12px;color:rgba(255,255,255,0.5);letter-spacing:0.5px;">Loading...</div>
  </div>

  <!-- Calibration Overlay -->
  <div class="overlay" id="calibrationOverlay">
    <div class="overlay-content">
      <div class="overlay-icon">ğŸ”</div>
      <div class="overlay-title" data-i18n="overlay.calibrationTitle">Calibration en cours...</div>
      <div class="overlay-message" data-i18n="overlay.calibrationMsg">Veuillez patienter pendant la recherche des limites</div>
      <div class="spinner"></div>
      <div style="color: #999; font-size: 14px; margin-top: 15px;" data-i18n="overlay.calibrationWarn">
        Ne pas interrompre le processus
      </div>
    </div>
  </div>

  <!-- Reboot Overlay -->
  <div class="overlay" id="rebootOverlay">
    <div class="overlay-content">
      <div class="overlay-icon">ğŸ”„</div>
      <div class="overlay-title" data-i18n="overlay.rebootTitle">RedÃ©marrage en cours...</div>
      <div class="overlay-message" id="rebootMessage" data-i18n="overlay.rebootMsg">Reconnexion automatique dans quelques secondes</div>
      <div class="spinner"></div>
      <div id="rebootStatus" style="color: #999; font-size: 14px; margin-top: 15px;" data-i18n="overlay.rebootWait">
        Veuillez patienter (~10-15 secondes)
      </div>
    </div>
  </div>

  <!-- Playlist Management Modal -->
  <div class="modal" id="playlistModal" onclick="closePlaylistModalOnOverlayClick(event)">
    <div class="modal-content" style="max-width: 650px; max-height: 85vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
      <div class="modal-title">ğŸ“‹ <span data-i18n="playlist.title">Playlist -</span> <span id="playlistModalTitle">Mode</span></div>
      
      <!-- Sticky Current Config Preview -->
      <div id="playlistCurrentConfig" style="background: rgba(102,126,234,0.06); padding: 12px; border-radius: 10px; margin-bottom: 12px; flex-shrink: 0; border: 1px solid rgba(102,126,234,0.15);">
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #4a5568;">âš™ï¸ <span data-i18n="playlist.currentConfig">Configuration actuelle:</span></div>
        <div id="playlistCurrentConfigContent" style="font-size: 12px; color: #4a5568;"></div>
        <button class="button btn-success" id="btnAddCurrentToPlaylist" style="margin-top: 8px; width: 100%; padding: 8px; font-size: 13px;">
          â• <span data-i18n="playlist.addToPlaylist">Ajouter Ã  la playlist</span>
        </button>
      </div>
      
      <!-- Presets List with Scroll -->
      <div style="flex: 1; overflow-y: auto; overflow-x: visible; border-top: 1.5px solid #e2e8f0; padding-top: 12px; min-height: 0;">
        <div style="font-weight: 600; margin-bottom: 10px; font-size: 13px; padding: 0 5px; color: #4a5568;">
          ğŸ“¦ <span data-i18n="playlist.savedPresets">Presets sauvegardÃ©s</span> (<span id="playlistCount">0</span>/20):
        </div>
        
        <!-- Search Input -->
        <input type="text" id="playlistSearchInput" placeholder="ğŸ” Rechercher un preset..." data-i18n-placeholder="playlist.searchPlaceholder" 
               oninput="filterPlaylistPresets(this.value)"
               style="width: 90%; margin: 0 0 10px 0; padding: 8px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 12px;">
        
        <div id="playlistPresetsList" style="padding-right: 5px; overflow: visible;">
          <!-- Presets will be dynamically inserted here -->
          <div style="color: #a0aec0; font-style: italic; padding: 20px; text-align: center; font-size: 12px;" data-i18n="playlist.noPresets">
            Aucun preset sauvegardÃ©
          </div>
        </div>
      </div>
      
      <!-- Sticky Close Button -->
      <div style="border-top: 1.5px solid #e2e8f0; padding: 12px 0 0 0; margin-top: 12px; background: white; flex-shrink: 0;">
        <button class="button btn-secondary" onclick="closePlaylistModal()" style="width: 100%; padding: 10px; font-size: 14px;">
          âœ–ï¸ <span data-i18n="common.close">Fermer</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Playlist Tooltip Overlay -->
  <div id="playlistTooltipOverlay"></div>

  <!-- Mode Change Confirmation Modal -->
  <div class="modal" id="modeChangeModal">
    <div class="modal-content">
      <div class="modal-title">âš ï¸ <span data-i18n="modal.modeChangeTitle">Changement de mode</span></div>
      <div class="modal-message" id="modalMessage" data-i18n-html="modal.modeChangeRunning">
        Une opÃ©ration est en cours. Le changement de mode va arrÃªter le mouvement et lancer une recalibration.
        <br><br>
        <strong>Voulez-vous continuer ?</strong>
      </div>
      <div style="margin: 20px 0; padding: 15px; background: rgba(237,137,54,0.08); border-radius: 10px; border: 1.5px solid rgba(237,137,54,0.3);">
        <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: normal;">
          <input type="checkbox" id="bypassCalibrationCheckbox" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: #ed8936;">
          <span style="color: #ed8936; font-weight: 600;" data-i18n="modal.bypassCalibration">/!\ Bypasser la calibration complÃ¨te</span>
        </label>
        <div style="font-size: 12px; color: #718096; margin-top: 8px; text-align: center;" data-i18n="modal.bypassCalibrationInfo">
          (Retour rapide au contact dÃ©but uniquement)
        </div>
      </div>
      <div class="modal-buttons">
        <button class="button btn-danger" onclick="cancelModeChange()" data-i18n="common.cancel">Annuler</button>
        <button class="button btn-success" onclick="confirmModeChange()" data-i18n="common.confirm">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Stop Confirmation Modal -->
  <div class="modal" id="stopModal">
    <div class="modal-content">
      <div class="modal-title">â¹ï¸ <span data-i18n="modal.stopTitle">ArrÃªter le mouvement</span></div>
      <div class="modal-message" data-i18n="modal.stopMessage">
        Voulez-vous arrÃªter le mouvement en cours ?
      </div>
      <div style="margin: 20px 0; padding: 15px; background: rgba(102,126,234,0.06); border-radius: 10px; border: 1.5px solid rgba(102,126,234,0.2);">
        <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: normal;">
          <input type="checkbox" id="returnToStartCheckbox" checked style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
          <span style="color: #5a67d8; font-weight: 600;">ğŸ  <span data-i18n="modal.returnToStart">Retour Ã  la position initiale (0mm)</span></span>
        </label>
        <div style="font-size: 12px; color: #718096; margin-top: 8px; text-align: center;" data-i18n="modal.returnToStartDisable">
          (DÃ©sactiver pour rester Ã  la position actuelle)
        </div>
      </div>
      <div class="modal-buttons">
        <button class="button btn-secondary" onclick="cancelStopModal()" data-i18n="common.cancel">Annuler</button>
        <button class="button btn-danger" onclick="confirmStopModal()">â¹ï¸ <span data-i18n="common.stop">ArrÃªter</span></button>
      </div>
    </div>
  </div>

  <!-- Modal for Sequencer Limit Warning -->
  <div class="modal" id="sequencerLimitModal">
    <div class="modal-content">
      <div class="modal-title">âš ï¸ <span data-i18n="modal.seqLimitTitle">Passage en Mode SÃ©quenceur</span></div>
      <div class="modal-message">
        <div style="background: rgba(102,126,234,0.06); padding: 15px; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 15px;">
          <div style="font-weight: 700; color: #5a67d8; margin-bottom: 8px;">ğŸ“‹ <span data-i18n="modal.seqLimitExpertMode">Mode Expert ActivÃ©</span></div>
          <div style="font-size: 14px; color: #4a5568;" data-i18n-html="modal.seqLimitActiveWillDisable">
            La limitation de course active sera <strong>DÃ‰SACTIVÃ‰E</strong> :
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; margin: 15px 0; padding: 15px; background: rgba(237,137,54,0.08); border-radius: 10px;">
          <div style="font-weight: 700; color: #ed8936;">â€¢ <span data-i18n="modal.seqLimitCurrent">Actuel :</span></div>
          <div id="seqModalCurrentLimit" style="color: #ed8936; font-weight: 700;">--</div>
          <div style="font-weight: 700; color: #48bb78;">â€¢ <span data-i18n="modal.seqLimitAfter">AprÃ¨s :</span></div>
          <div id="seqModalAfterLimit" style="color: #48bb78; font-weight: 700;">--</div>
        </div>
        
        <div style="background: #f7fafc; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
          <div style="font-weight: 700; margin-bottom: 8px; color: #2d3748;">ğŸ”§ <span data-i18n="modal.seqLimitReason">Raison :</span></div>
          <div style="font-size: 13px; color: #718096; line-height: 1.5;" data-i18n="modal.seqLimitReasonText">
            Le sÃ©quenceur peut contenir des lignes de calibration qui rÃ©initialisent cette limite.
          </div>
        </div>
        
        <div style="background: rgba(72,187,120,0.08); padding: 12px; border-radius: 10px; border-left: 4px solid #48bb78;">
          <div style="font-weight: 700; color: #38a169; margin-bottom: 5px;">ğŸ’¡ <span data-i18n="modal.seqLimitInSeqMode">En mode sÃ©quenceur :</span></div>
          <div style="font-size: 13px; color: #4a5568;" data-i18n-html="modal.seqLimitFullControl">
            Vous avez le <strong>contrÃ´le total</strong> des valeurs de chaque ligne.
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; font-weight: 700; color: #2d3748;" data-i18n="modal.seqLimitContinue">
          Continuer ?
        </div>
      </div>
      <div class="modal-buttons">
        <button class="button btn-danger" onclick="cancelSequencerLimitChange()" data-i18n="common.cancel">Annuler</button>
        <button class="button btn-success" onclick="confirmSequencerLimitChange()" data-i18n="common.confirm">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Unified Alert Modal (replaces native alert()) -->
  <div class="modal" id="unifiedAlertModal">
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-title">
        <span id="unifiedAlertIcon" style="margin-right: 8px;">â„¹ï¸</span>
        <span id="unifiedAlertTitle" data-i18n="common.info">Information</span>
      </div>
      <div class="modal-message" id="unifiedAlertMessage" style="padding: 15px 0; line-height: 1.6;">
        Message
      </div>
      <div class="modal-buttons" style="justify-content: center;">
        <button class="button btn-primary" id="unifiedAlertOkBtn" onclick="closeAlertModal()" style="min-width: 120px;">OK</button>
      </div>
    </div>
  </div>

  <!-- Unified Confirm Modal (replaces native confirm()) -->
  <div class="modal" id="unifiedConfirmModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-title">
        <span id="unifiedConfirmIcon" style="margin-right: 8px;">âš ï¸</span>
        <span id="unifiedConfirmTitle" data-i18n="common.confirmation">Confirmation</span>
      </div>
      <div class="modal-message" id="unifiedConfirmMessage" style="padding: 15px 0; line-height: 1.6;">
        Message
      </div>
      <div class="modal-buttons">
        <button class="button btn-secondary" id="unifiedConfirmCancelBtn" onclick="closeConfirmModal(false)" data-i18n="common.cancel">Annuler</button>
        <button class="button btn-success" id="unifiedConfirmOkBtn" onclick="closeConfirmModal(true)" data-i18n="common.confirm">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- Unified Prompt Modal (replaces native prompt()) -->
  <div class="modal" id="unifiedPromptModal">
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-title">
        <span id="unifiedPromptIcon" style="margin-right: 8px;">âœï¸</span>
        <span id="unifiedPromptTitle">Input</span>
      </div>
      <div class="modal-message" id="unifiedPromptMessage" style="padding: 10px 0; line-height: 1.6;">
        Message
      </div>
      <div style="padding: 5px 0 15px;">
        <input type="text" id="unifiedPromptInput" 
               style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;"
               autocomplete="off">
      </div>
      <div class="modal-buttons">
        <button class="button btn-secondary" id="unifiedPromptCancelBtn" onclick="closePromptModal(null)">Annuler</button>
        <button class="button btn-primary" id="unifiedPromptOkBtn" onclick="closePromptModal(document.getElementById('unifiedPromptInput').value)" style="min-width: 100px;">OK</button>
      </div>
    </div>
  </div>

  <!-- WiFi Configuration Modal -->
  <div class="modal" id="wifiConfigModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-title">ğŸ“¶ <span data-i18n="wifi.configTitle">Configuration WiFi</span></div>
      
      <div style="padding: 15px 0;">
        <!-- Current EEPROM Config Display -->
        <div id="wifiCurrentConfig" style="background: rgba(102,126,234,0.06); padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
          <div style="font-weight: 500; margin-bottom: 6px; font-size: 13px;">ğŸ“¦ <span data-i18n="wifi.currentEepromConfig">Configuration actuelle en EEPROM:</span></div>
          <div id="wifiCurrentSsid" style="font-size: 12px; color: #555; font-family: monospace;" data-i18n="common.loading">Chargement...</div>
        </div>
        
        <!-- Edit Form -->
        <div style="background: #f5f5f5; padding: 15px; border-radius: 6px;">
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-weight: 500; margin-bottom: 5px; font-size: 13px;" data-i18n="wifi.ssidLabel">SSID:</label>
            <input type="text" id="wifiEditSsid" placeholder="Nom du rÃ©seau WiFi" data-i18n-placeholder="wifi.ssidPlaceholder" 
                   style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 13px; font-family: monospace;">
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-weight: 500; margin-bottom: 5px; font-size: 13px;" data-i18n="wifi.passwordLabel">Mot de passe:</label>
            <input type="password" id="wifiEditPassword" placeholder="Mot de passe WiFi" data-i18n-placeholder="wifi.passwordPlaceholder" 
                   style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 13px; font-family: monospace;">
            <label style="display: flex; align-items: center; margin-top: 5px; cursor: pointer; font-size: 12px; color: #666;">
              <input type="checkbox" id="wifiShowPassword" style="margin-right: 5px;">
              <span data-i18n="wifi.showPassword">Afficher le mot de passe</span>
            </label>
          </div>
          
          <div id="wifiEditStatus" style="padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 12px; display: none;"></div>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="button btn-secondary" onclick="closeWifiConfigModal()">âœ–ï¸ <span data-i18n="common.cancel">Annuler</span></button>
        <button class="button btn-success" id="btnSaveWifiConfig">ğŸ’¾ <span data-i18n="common.save">Enregistrer</span></button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Common Status (COMPACT VERSION) -->
    <div class="status-compact">
      
      <!-- Header Row: Ã‰tat + Actions -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 16px; background:linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.06)); border-bottom:1px solid rgba(102,126,234,0.1);">
        <span style="font-weight:700; font-size:15px; color:#5a67d8;">
          <span data-i18n="status.stateLabel">Ã‰tat:</span> <span id="state" style="color:#2d3748;" data-i18n="status.init">Initialisation...</span>
        </span>
        <div class="flex-gap-6">
          <button class="btn-compact" id="btnLangToggle" onclick="I18n.toggleLanguage()" title="Switch to English" style="background: transparent; border: 1.5px solid rgba(102,126,234,0.2); font-size: 18px; padding: 4px 8px; cursor: pointer; border-radius: 6px;">ğŸ‡«ğŸ‡·</button>
          <button class="btn-compact btn-primary" id="btnCalibrateCommon" title="Calibrer les limites">ğŸ” <span data-i18n="status.calib">Calib</span></button>
          <button class="btn-compact btn-info" id="btnShowLogs" title="Afficher logs">ğŸ“‹ <span data-i18n="status.logs">Logs</span></button>
          
          <button class="btn-compact btn-success" id="btnShowStats" title="Afficher statistiques">ğŸ“Š <span data-i18n="status.stats">Stats</span></button>
          <button class="btn-compact" id="btnShowSystem" title="Afficher statistiques systÃ¨me" style="background: linear-gradient(135deg,#4299e1,#3182ce); color: white; border-radius:6px;">âš™ï¸ <span data-i18n="status.sys">Sys</span></button>
        </div>
      </div>
      
      <!-- Row 2: Position + Course -->
      <div style="padding:6px 15px; font-size:13px; border-bottom:1px solid #edf2f7;">
        ğŸ“ <strong data-i18n="status.position">Position:</strong> <span id="position">0.0 mm (0 steps)</span>
        &nbsp;&nbsp;â€¢&nbsp;&nbsp;
        <strong data-i18n="status.course">Course:</strong> <span id="sensorsInvertedIcon" title="Capteurs inversÃ©s (STARTâ†”END)" data-i18n-title="status.sensorsInverted" style="display:none; cursor:help;">ğŸ”„</span> <span id="totalDist">-- mm</span>
        <button id="btnConfigMaxDist" class="btn-icon" title="Limiter course" data-i18n-title="status.limitCourse" style="margin-left:4px;">âš™ï¸</button>
      </div>
      
      <!-- Max Distance Config Panel (collapsible) -->
      <div id="maxDistConfigPanel" style="display:none; padding:10px 15px; background:rgba(237,137,54,0.06); border-bottom:1px solid rgba(237,137,54,0.15);">
        <div style="font-weight:700; color:#ed8936; margin-bottom:6px; font-size:12px;">âš™ï¸ <span data-i18n="status.courseLimitation">Limitation de course</span></div>
        <div style="font-size:11px; color:#718096; margin-bottom:8px;">
          â„¹ï¸ <span data-i18n="status.courseLimitInfo">Limite la zone utilisable sans recalibrer</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
          <span style="font-size:11px; font-weight:600; min-width:45px; color:#4a5568;" data-i18n="status.limit">Limite:</span>
          <input type="range" id="maxDistLimitSlider" min="50" max="100" value="100" step="1" style="flex:1; height:6px; accent-color:#667eea;" disabled>
          <span id="maxDistLimitValue" style="font-weight:700; font-size:12px; min-width:40px; color:#2d3748;">100%</span>
          <span id="maxDistLimitMM" style="color:#718096; font-size:11px; min-width:70px;">(-- mm)</span>
        </div>
        <div class="flex-gap-6">
          <button id="btnApplyMaxDistLimit" class="btn-compact btn-success" disabled>âœ… OK</button>
          <button id="btnCancelMaxDistLimit" class="btn-compact btn-secondary">âœ• <span data-i18n="common.cancel">Annuler</span></button>
        </div>
        <div style="font-size:10px; color:#f56565; margin-top:6px; display:none;" id="maxDistLimitWarning" data-i18n="status.modifyReadyOnly">
          âš ï¸ Modification en Ã©tat PRÃŠT uniquement
        </div>
        <!-- Sensors Inversion Option -->
        <div style="display:flex; align-items:center; gap:8px; margin-top:10px; padding-top:8px; border-top:1px dashed rgba(237,137,54,0.2);">
          <label style="font-size:11px; display:flex; align-items:center; gap:6px; cursor:pointer; color:#4a5568;">
            <input type="checkbox" id="chkSensorsInverted" style="width:16px; height:16px; accent-color:#667eea;">
            <span>ğŸ”„ <span data-i18n="status.invertStartEnd">Inverser START â†” END</span></span>
          </label>
          <span id="sensorsInvertedStatus" style="font-size:10px; color:#718096;">(Normal)</span>
        </div>
      </div>
      
      <!-- Row 3: Vitesses -->
      <div style="padding:6px 15px; font-size:13px; border-bottom:1px solid #edf2f7;">
        âš¡ <strong data-i18n="status.speed">Vitesse:</strong> <span id="currentSpeed">â†—ï¸ --  â€¢  â†™ï¸ --</span>
        <span style="color:#a0aec0; font-size:11px; margin-left:8px;">(-- c/min)</span>
        <span style="margin-left:12px; font-size:16px; cursor:help;" id="speedIcon" title="">â¸ï¸</span>
        <span id="realSpeed" style="font-size:12px; color:#4a5568; margin-left:4px;">0 cm/s</span>
      </div>
      
      <!-- Row 4: Distance + Progress Bar (colonnes fixes) -->
      <div style="padding:6px 15px; font-size:13px; display:grid; grid-template-columns: 280px 1fr 50px; gap:10px; align-items:center; border-bottom:1px solid #edf2f7;">
        <div style="white-space:nowrap;">
          ğŸ“Š <strong data-i18n="status.distanceLabel">Distance:</strong> <span id="statsRecordingWarning" style="display: none; color: #ed8936; cursor: help; margin-left: 4px;" title="âš ï¸ Enregistrement des stats dÃ©sactivÃ©" data-i18n-title="stats.recordingDisabledWarning">âš ï¸</span> <span id="milestoneIcon" style="font-size: 20px; margin-left: 8px; cursor: help; display: inline-block; transition: transform 0.3s;" title=""></span> <span id="totalTraveled">0.000 m</span> <button class="btn-icon" id="btnResetDistanceCommon" title="RÃ©initialiser distance" data-i18n-title="status.resetDistance" style="margin-left:4px;">â†»</button>
          
        </div>
        <div style="height:8px; background:#edf2f7; border-radius:4px; overflow:hidden;">
          <div id="progressMini" style="width:0%; height:100%; background:linear-gradient(90deg,#667eea,#764ba2); transition:width 0.3s; border-radius:4px;"></div>
        </div>
        <span id="progressPct" style="font-weight:700; font-size:12px; text-align:right; color:#2d3748;">0.0%</span>
      </div>
      
      <!-- Pending Changes Alert (conditional) -->
      <div id="pendingChanges" style="display:none; padding:6px 15px; background:rgba(237,137,54,0.08); color:#ed8936; font-weight:600; font-size:12px; border-bottom:1px solid rgba(237,137,54,0.15);">
        â³ <span data-i18n="status.pendingChanges">Changements en attente (fin de cycle)</span>
      </div>
      
    </div>

    <!-- Logs Panel (hidden by default) -->
    <div id="logsPanel" style="display: none; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 12px rgba(102,126,234,0.08), 0 1px 2px rgba(0,0,0,0.04); margin-bottom: 15px; border: 1px solid rgba(102,126,234,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
        <h3 style="margin: 0; color: #5a67d8; font-size: 18px; font-weight: 700;">ğŸ“‹ Logs & Debug</h3>
        <button id="btnCloseLogs" style="background: linear-gradient(135deg,#fc8181,#f56565); color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ•</button>
      </div>

      <!-- Log Console -->
      <div class="mb-12">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <label style="font-weight: 600; color: #4a5568; font-size: 13px;" data-i18n="system.realTimeConsole">Console temps rÃ©el:</label>
          <div class="flex-gap-6">
            <button class="button btn-secondary" id="btnClearLogsPanel" style="padding: 4px 10px; font-size: 11px;">ğŸ—‘ï¸ <span data-i18n="system.clearAll">Effacer</span></button>
          </div>
        </div>
        <div id="logConsolePanel" style="height: 180px; overflow: auto; background: #1e1e1e; color: #d4d4d4; padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; border: 1px solid #333;" data-i18n="system.logsAppear">(les logs apparaÃ®tront ici...)</div>
      </div>

      <!-- Debug Controls -->
      <div class="box-gray mb-12">
        <label style="font-weight: bold; color: #333; display: block; margin-bottom: 8px; font-size: 13px;">âš™ï¸ <span data-i18n="system.debugLevel">Niveau de debug:</span></label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="debugLevelCheckbox" style="width: 16px; height: 16px; margin-right: 6px;">
            <span class="text-md" data-i18n="system.enableDebugVerbose">Activer logs DEBUG (verbose)</span>
          </label>
          <span style="color: #666; font-size: 11px; margin-left: auto;">âš ï¸ <span data-i18n="system.canSlow">Peut ralentir</span></span>
        </div>
      </div>

      <!-- Historical Logs -->
      <div style="background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <label style="font-weight: bold; color: #856404; font-size: 13px;">ğŸ“š <span data-i18n="system.logHistory">Historique des logs:</span></label>
          <button class="button btn-danger" id="btnClearAllLogFiles" style="padding: 4px 10px; font-size: 11px;">ğŸ—‘ï¸ <span data-i18n="system.clearAll">Nettoyer tout</span></button>
        </div>
        <div id="logFilesList" style="max-height: 130px; overflow-y: auto; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
          <div style="color: #999; font-style: italic; font-size: 11px;" data-i18n="system.listLoading">Chargement de la liste...</div>
        </div>
      </div>
    </div>

    <!-- Statistics Panel -->
    <div id="statsPanel" style="display: none; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 12px rgba(102,126,234,0.08), 0 1px 2px rgba(0,0,0,0.04); margin-bottom: 15px; border: 1px solid rgba(102,126,234,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 2px solid #48bb78; padding-bottom: 8px;">
        <h3 style="margin: 0; color: #38a169; font-size: 18px; font-weight: 700;">
          ğŸ“Š <span data-i18n="stats.title">Statistiques</span>
        </h3>
        <button id="btnCloseStats" style="background: linear-gradient(135deg,#fc8181,#f56565); color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ•</button>
      </div>

      <!-- Stats Table -->
      <div style="margin-bottom: 20px; overflow-x: auto; max-height: 300px; overflow-y: auto; border: 1.5px solid #e2e8f0; border-radius: 8px;">
        <table id="statsTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead style="position: sticky; top: 0; background: #f7fafc; z-index: 1;">
            <tr style="border-bottom: 2px solid #48bb78;">
              <th style="padding: 8px; text-align: left; font-weight: 600; color: #4a5568;" data-i18n="stats.dateCol">Date</th>
              <th style="padding: 8px; text-align: center; font-weight: 600; color: #4a5568;" data-i18n="stats.dayCol">Jour</th>
              <th style="padding: 8px; text-align: center; font-weight: 600; color: #4a5568;">ğŸ†</th>
              <th style="padding: 8px; text-align: right; font-weight: 600; color: #4a5568;" data-i18n="stats.distanceCol">Distance</th>
            </tr>
          </thead>
          <tbody id="statsTableBody">
            <tr>
              <td colspan="4" style="padding: 20px; text-align: center; color: #a0aec0; font-style: italic;" data-i18n="stats.noStats">Aucune statistique disponible</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Stats Footer (outside scroll container) -->
      <div style="background: rgba(72,187,120,0.08); border: 1.5px solid rgba(72,187,120,0.2); border-radius: 10px; padding: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; font-weight: 700;">
        <span data-i18n="stats.total">TOTAL</span>
        <span>ğŸ†</span>
        <span id="statsTotalMilestone" style="font-size: 18px;">ğŸ¯</span>
        <span id="statsTotalDistance" style="color: #38a169; font-size: 15px;">0 km</span>
      </div>

      <!-- Stats Action Buttons -->
      <div style="margin-bottom: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; align-items: center;">
        <button id="btnExportStats" class="button" style="padding: 8px 20px; font-size: 13px; background: linear-gradient(135deg,#48bb78,#38a169); color: white;">
          ğŸ“¥ <span data-i18n="stats.exportBtn">Exporter</span>
        </button>
        <button id="btnImportStats" class="button" style="padding: 8px 20px; font-size: 13px; background: linear-gradient(135deg,#4299e1,#3182ce); color: white;">
          ğŸ“¤ <span data-i18n="stats.importBtn">Importer</span>
        </button>
        <button id="btnClearStats" class="button btn-danger" style="padding: 8px 20px; font-size: 13px;">
          ğŸ—‘ï¸ <span data-i18n="stats.clearBtn">Effacer tout</span>
        </button>
        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 12px; background: #f7fafc; border-radius: 8px; border: 1.5px solid #e2e8f0;" title="DÃ©sactiver pour ignorer les enregistrements des stats" data-i18n-title="stats.disableRecordingTooltip">
          <input type="checkbox" id="statsRecordingEnabled" checked style="width: 16px; height: 16px; cursor: pointer; accent-color: #667eea;">
          <span style="font-size: 12px; color: #718096;" data-i18n="stats.enableRecording">Activer sauvegarde</span>
        </label>
      </div>
      
      <!-- Hidden file input for import -->
      <input type="file" id="statsFileInput" accept=".json" class="hidden">

      <!-- Histogram -->
      <div style="background: #f7fafc; padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0;">
        <h4 style="margin: 0 0 12px 0; color: #2d3748; font-size: 14px; font-weight: 600;">ğŸ“ˆ <span data-i18n="stats.historyTitle">Historique (3 mois glissants)</span></h4>
        <canvas id="statsChart" style="max-height: 250px;"></canvas>
      </div>
    </div>

    <!-- System Stats Panel (hidden by default like Stats panel) -->
    <div id="systemPanel" style="display: none; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 12px rgba(102,126,234,0.08), 0 1px 2px rgba(0,0,0,0.04); margin-bottom: 15px; border: 1px solid rgba(102,126,234,0.08);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
        <h3 style="margin: 0; color: #5a67d8; font-size: 18px; font-weight: 700;">âš™ï¸ <span data-i18n="system.title">SystÃ¨me</span></h3>
        <button id="btnCloseSystem" style="background: linear-gradient(135deg,#fc8181,#f56565); color: white; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">âœ•</button>
      </div>

      <!-- System Stats Grid -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
        <div class="box-gray">
          <div style="color: #718096; font-size: 11px; margin-bottom: 4px;" data-i18n="system.cpu">CPU</div>
          <div id="sysCpuFreq" class="value-display">-- MHz</div>
        </div>
        
        <div class="box-gray">
          <div style="color: #718096; font-size: 11px; margin-bottom: 4px;">ğŸŒ¡ï¸ <span data-i18n="system.temperature">TempÃ©rature</span></div>
          <div id="sysTemp" class="value-display">-- Â°C</div>
        </div>
        
        <div class="box-gray">
          <div style="color: #718096; font-size: 11px; margin-bottom: 4px;">ğŸ’¾ <span data-i18n="system.ram">RAM</span></div>
          <div id="sysRam" class="value-display">-- KB libre</div>
          <div id="sysRamPercent" style="font-size: 11px; color: #718096; margin-top: 2px;">--% utilisÃ©</div>
        </div>
        
        <div class="box-gray">
          <div style="color: #718096; font-size: 11px; margin-bottom: 4px;">ğŸ§  <span data-i18n="system.psram">PSRAM</span></div>
          <div id="sysPsram" class="value-display">-- MB libre</div>
          <div id="sysPsramPercent" style="font-size: 11px; color: #718096; margin-top: 2px;">--% utilisÃ©</div>
        </div>
        
        <div class="box-gray">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <div style="color: #718096; font-size: 11px;">ğŸ“¶ <span data-i18n="system.wifiLabel">WiFi</span></div>
            <div style="display: flex; gap: 4px;">
              <button id="btnEditWifi" style="background: linear-gradient(135deg,#ed8936,#dd6b20); color: white; border: none; padding: 3px 8px; border-radius: 6px; cursor: pointer; font-size: 10px;" title="Ã‰diter la config WiFi" data-i18n-title="wifi.editWifi">
                âœï¸
              </button>
              <button id="btnRefreshWifi" style="background: linear-gradient(135deg,#4299e1,#3182ce); color: white; border: none; padding: 3px 8px; border-radius: 6px; cursor: pointer; font-size: 10px;" title="Reconnecter le WiFi" data-i18n-title="wifi.reconnectWifi">
                ğŸ”„
              </button>
            </div>
          </div>
          <div id="sysWifi" class="value-display">-- dBm</div>
          <div id="sysWifiQuality" style="font-size: 11px; color: #718096; margin-top: 2px;">--</div>
        </div>
        
        <div class="box-gray">
          <div style="color: #718096; font-size: 11px; margin-bottom: 4px;">âš¡ <span data-i18n="system.uptime">Uptime</span></div>
          <div id="sysUptime" class="value-display">--</div>
        </div>
      </div>

      <!-- Network Info Section -->
      <div id="networkInfoSection" style="margin-top: 15px; background: rgba(102,126,234,0.06); padding: 12px; border-radius: 10px; border-left: 4px solid #667eea;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div style="font-weight: 700; color: #5a67d8; font-size: 13px;">ğŸŒ <span data-i18n="wifi.network">RÃ©seau</span></div>
          <div id="sysDegradedBadge" style="display: none; background: linear-gradient(135deg,#ed8936,#dd6b20); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700;">âš ï¸ <span data-i18n="wifi.degradedMode">MODE DÃ‰GRADÃ‰</span></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
          <div>
            <div style="color: #718096; font-size: 10px;" data-i18n="wifi.ipSta">IP STA (WiFi)</div>
            <div id="sysIpSta" style="font-weight: 600; color: #2d3748; font-family: monospace;">--</div>
          </div>
          <div>
            <div style="color: #718096; font-size: 10px;" data-i18n="wifi.ipAp">IP AP (Point d'accÃ¨s)</div>
            <div id="sysIpAp" style="font-weight: 600; color: #2d3748; font-family: monospace;">--</div>
          </div>
          <div>
            <div style="color: #718096; font-size: 10px;" data-i18n="wifi.hostname">Hostname (mDNS)</div>
            <div id="sysHostname" style="font-weight: 600; color: #667eea; font-family: monospace;">--</div>
          </div>
          <div>
            <div style="color: #718096; font-size: 10px;" data-i18n="wifi.connectedSsid">SSID connectÃ©</div>
            <div id="sysSsid" style="font-weight: 600; color: #2d3748;">--</div>
          </div>
          <div style="grid-column: span 2;">
            <div style="color: #718096; font-size: 10px;">ğŸ“¡ <span data-i18n="wifi.apClients">Clients AP connectÃ©s</span></div>
            <div id="sysApClients" style="font-weight: 700; color: #48bb78;">0</div>
          </div>
        </div>
      </div>

      <!-- Logging Configuration -->
      <div style="margin-top: 15px; background: #f5f5f5; padding: 12px; border-radius: 6px;">
        <div style="font-weight: bold; color: #333; font-size: 13px; margin-bottom: 10px;">ğŸ“‹ <span data-i18n="system.logConfig">Configuration des logs</span></div>
        
        <!-- Enable/Disable Logging -->
        <div class="mb-10">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
            <input type="checkbox" id="chkLoggingEnabled" checked style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-size: 13px; color: #333;" data-i18n="system.enableLogs">Activer les logs (console + fichiers)</span>
          </label>
          <div style="font-size: 11px; color: #666; margin-left: 26px; margin-top: 4px;">
            âš ï¸ <span data-i18n="system.enableLogsWarn">DÃ©sactiver rÃ©duit l'utilisation CPU mais supprime tous les logs</span>
          </div>
        </div>
        
        <!-- Debug Level Toggle -->
        <div style="margin-bottom: 4px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
            <input type="checkbox" id="chkDebugLevel" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-size: 13px; color: #333;" data-i18n="system.debugLogs">Activer logs DEBUG (verbose)</span>
          </label>
          <div style="font-size: 11px; color: #666; margin-left: 26px; margin-top: 4px;">
            â„¹ï¸ <span data-i18n="system.debugLogsInfo">Niveau INFO (messages normaux) par dÃ©faut</span>
          </div>
        </div>
      </div>

      <!-- Reboot Button Only -->
      <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button id="btnReboot" class="button btn-danger" style="flex: 1; padding: 12px; font-size: 14px; font-weight: bold;">
          ğŸ”„ <span data-i18n="system.rebootBtn">RedÃ©marrer</span>
        </button>
      </div>
    </div>

    <!-- Welcome message (shown before first calibration) -->
    <div class="welcome-message" id="welcomeMessage">
      <h2>ğŸ‘‹ <span data-i18n="welcome.title">Bienvenue!</span></h2>
      <p>ğŸ”§ <span data-i18n="welcome.line1">Avant de commencer, veuillez effectuer une calibration pour dÃ©tecter les limites de course.</span></p>
      <p>ğŸ‘† <span data-i18n-html="welcome.line2">Cliquez sur le bouton <strong>"ğŸ” Calibrer"</strong> dans la section "Outils communs" ci-dessus.</span></p>
      <p style="font-size: 14px; opacity: 0.8; margin-top: 20px;">
        âš™ï¸ <span data-i18n="welcome.line3">Les modes de contrÃ´le apparaÃ®tront automatiquement aprÃ¨s la calibration.</span>
      </p>
    </div>

    <!-- Tabs Navigation (after status) -->
    <div class="tabs hidden-until-calibrated" id="tabsContainer">
      <button class="tab active" data-tab="simple">ğŸ”„ <span data-i18n="tabs.simple">Simple</span></button>
      <button class="tab" data-tab="pursuit">ğŸ¯ <span data-i18n="tabs.pursuit">Poursuite</span></button>
      <button class="tab" data-tab="oscillation">ã€°ï¸ <span data-i18n="tabs.oscillation">Oscillation</span></button>
      <button class="tab" data-tab="chaos">ğŸ² <span data-i18n="tabs.chaos">Chaos</span></button>
      <button class="tab" data-tab="tableau">ğŸ“‹ <span data-i18n="tabs.sequencer">SÃ©quenceur</span></button>
    </div>

    <!-- MODE SIMPLE Tab Content -->
    <div class="tab-content active hidden-until-calibrated" id="tabSimple">
      <div class="controls">
        
      <!-- Position/Distance - 2-Column Grid -->
      <div class="form-row-compact">
        <div class="form-group-compact d-block">
          <div>
            <label class="label-inline" data-i18n="simple.startPosition">Position dÃ©part:</label>
            <input type="number" id="startPosition" min="0" step="1" value="0" class="input-compact">
            <span class="unit-label">mm</span>
          </div>
          <div class="mt-8">
            <button class="preset-btn-sm btn-preset" data-start="0">0mm</button>
            <button class="preset-btn-sm btn-preset" data-start="25">25mm</button>
            <button class="preset-btn-sm btn-preset" data-start="50">50mm</button>
            <button class="preset-btn-sm btn-preset" data-start="75">75mm</button>
            <button class="preset-btn-sm btn-preset" data-start="100">100mm</button>
          </div>
          <div class="mt-4">
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="-20">-20</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="-10">-10</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="-5">-5</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="+5">+5</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="+10">+10</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-start-rel="+20">+20</button>
          </div>
        </div>
        
        <div class="form-group-compact d-block">
          <div>
            <label class="label-inline" data-i18n="simple.distance">Distance:</label>
            <input type="number" id="distance" min="0" step="1" value="50" class="input-compact">
            <span class="unit-label">mm</span>
          </div>
          <div class="mt-8">
            <button class="preset-btn-sm btn-preset" data-distance="25">25mm</button>
            <button class="preset-btn-sm btn-preset" data-distance="50">50mm</button>
            <button class="preset-btn-sm btn-preset" data-distance="75">75mm</button>
            <button class="preset-btn-sm btn-preset" data-distance="100">100mm</button>
            <button class="preset-btn-sm btn-preset" data-distance="125">125mm</button>
          </div>
          <div class="mt-4">
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="-20">-20</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="-10">-10</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="-5">-5</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="+5">+5</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="+10">+10</button>
            <button class="preset-btn-sm btn-preset btn-relative" data-distance-rel="+20">+20</button>
          </div>
        </div>
      </div>
      
      <!-- SÃ©parateur -->
      <div class="divider"></div>
      
      <!-- Speed Mode Toggle - Radio Buttons -->
      <div class="form-group-compact" style="margin-bottom: 15px;">
        <label class="label-inline">âš™ï¸ <span data-i18n="simple.speedLabel">Vitesse:</span></label>
        <div class="radio-inline">
          <label>
            <input type="radio" name="speedMode" id="speedModeUnified" checked>
            <span data-i18n="simple.unified">UnifiÃ©e</span>
          </label>
          <label>
            <input type="radio" name="speedMode" id="speedModeSeparate">
            <span data-i18n="simple.separate">SÃ©parÃ©e</span>
          </label>
        </div>
      </div>
      
      <!-- Unified Speed - Single Line -->
      <div id="speedUnifiedGroup" class="speed-control-inline mb-12">
        <label class="label-inline" data-i18n="simple.speedLabel">Vitesse:</label>
        <input type="number" id="speedUnified" min="0" max="20" step="0.1" value="5" class="input-compact">
        <button class="preset-btn-sm btn-preset" data-speed-unified="0.5" title="Ultra lent">0.5 ğŸŒ</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="1" title="TrÃ¨s lent">1</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="2">2</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="3">3</button>
        <button class="preset-btn-sm btn-preset active" data-speed-unified="5" title="Normal">5 âœ“</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="10">10</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="15">15</button>
        <button class="preset-btn-sm btn-preset" data-speed-unified="20" title="Maximum">20 âš¡</button>
      </div>
      
      <!-- Separate Speeds - Stacked -->
      <div id="speedSeparateGroup" style="display: none; margin-bottom: 12px;">
        <div class="speed-control-inline" style="margin-bottom: 8px;">
          <label class="label-inline" data-i18n="simple.forward">Aller:</label>
          <input type="number" id="speedForward" min="0" max="20" step="0.1" value="5" class="input-compact">
          <button class="preset-btn-sm btn-preset" data-speed-forward="0.5">0.5 ğŸŒ</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="1">1</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="2">2</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="3">3</button>
          <button class="preset-btn-sm btn-preset active" data-speed-forward="5">5 âœ“</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="10">10</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="15">15</button>
          <button class="preset-btn-sm btn-preset" data-speed-forward="20">20 âš¡</button>
        </div>
        <div class="speed-control-inline">
          <label class="label-inline" data-i18n="simple.backward">Retour:</label>
          <input type="number" id="speedBackward" min="0" max="20" step="0.1" value="5" class="input-compact">
          <button class="preset-btn-sm btn-preset" data-speed-backward="0.5">0.5 ğŸŒ</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="1">1</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="2">2</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="3">3</button>
          <button class="preset-btn-sm btn-preset active" data-speed-backward="5">5 âœ“</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="10">10</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="15">15</button>
          <button class="preset-btn-sm btn-preset" data-speed-backward="20">20 âš¡</button>
        </div>
      </div>

      <!-- SÃ©parateur -->
      <div class="divider"></div>

      <!-- Zone Effects - Collapsible Section -->
      <div class="section-collapsible collapsed" id="zoneEffectSection">
        <div class="section-collapsible-header" onclick="toggleZoneEffectSection()">
          <span class="collapse-icon">â–¼</span> <span id="zoneEffectHeaderText" data-i18n="simple.zoneEffectsDisabled">ğŸ¯ Effets de Zone - dÃ©sactivÃ©s</span>
        </div>
        
        <div class="section-collapsible-content">
          <!-- Zone Size -->
          <div class="speed-control-inline mb-10">
            <label class="label-inline">Zone:</label>
            <input type="number" id="zoneEffectMM" min="10" max="200" step="5" value="50" class="input-compact">
            <span class="unit-label">mm</span>
            <button class="preset-btn-sm btn-preset" data-zone-mm="10">10</button>
            <button class="preset-btn-sm btn-preset" data-zone-mm="25">25</button>
            <button class="preset-btn-sm btn-preset active" data-zone-mm="50">50</button>
            <button class="preset-btn-sm btn-preset" data-zone-mm="75">75</button>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; padding-left: 4px; font-size: 13px;">
            <label style="cursor: pointer;">
              <input type="checkbox" id="zoneEffectStart" checked style="margin-right: 3px;">
              <span data-i18n="simple.zoneStart">DÃ©but</span>
            </label>
            <label style="cursor: pointer;">
              <input type="checkbox" id="zoneEffectEnd" checked style="margin-right: 3px;">
              <span data-i18n="simple.zoneEnd">Fin</span>
            </label>
            <label style="cursor: pointer; color: #666;" data-i18n-title="simple.zoneMirrorTooltip" title="Les zones DÃ©but/Fin restent liÃ©es Ã  leur position physique quel que soit le sens du mouvement">
              <input type="checkbox" id="zoneEffectMirror" style="margin-right: 3px;">
              &#x1F4CC; <span data-i18n="simple.zoneMirror">Position physique</span>
            </label>
          </div>

          <!-- ===== 1. Speed Effect ===== -->
          <div style="background: #f8f9fa; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
            <div class="speed-control-inline mb-5">
              <label style="font-weight: bold; font-size: 13px; min-width: 90px;">ğŸš€ <span data-i18n="simple.speedEffect">Vitesse:</span></label>
              <select id="speedEffectType" style="width: 130px; padding: 5px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0" data-i18n="simple.speedEffectNone">Aucun</option>
                <option value="1" selected data-i18n="simple.speedEffectDecel">DÃ©cÃ©lÃ©ration</option>
                <option value="2" data-i18n="simple.speedEffectAccel">AccÃ©lÃ©ration</option>
              </select>
              
              <label style="margin-left: 10px; font-size: 13px;" data-i18n="simple.curve">Courbe:</label>
              <select id="speedCurveSelect" style="width: 110px; padding: 5px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0" data-i18n="simple.curveLinear">LinÃ©aire</option>
                <option value="1" selected data-i18n="simple.curveSinusoidal">SinusoÃ¯dal</option>
                <option value="2" data-i18n="simple.curveTriInv">Triangle Inv.</option>
                <option value="3" data-i18n="simple.curveSinInv">Sinus Inv.</option>
              </select>
              
              <span style="margin-left: 10px; font-size: 13px;" data-i18n="simple.intensity">IntensitÃ©:</span>
              <input type="range" id="speedIntensity" min="0" max="100" step="5" value="75" style="width: 80px;">
              <span id="speedIntensityValue" style="font-weight: bold; min-width: 35px; font-size: 13px;">75%</span>
            </div>
          </div>

          <!-- ===== 2. Random Turnback ===== -->
          <div style="background: #f0f7ff; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
            <div class="speed-control-inline">
              <label style="font-size: 13px; margin-right: 10px;">
                <input type="checkbox" id="randomTurnbackEnabled" style="margin-right: 5px;">
                <strong>ğŸ”„ <span data-i18n="simple.randomTurnback">Retour alÃ©atoire</span></strong>
              </label>
              <span style="font-size: 13px; color: #666;" data-i18n="simple.randomTurnbackChance">Chance:</span>
              <input type="range" id="turnbackChance" min="5" max="100" step="5" value="30" style="width: 80px; margin-left: 5px;">
              <span id="turnbackChanceValue" style="font-weight: bold; min-width: 35px; font-size: 13px;">30%</span>
              <span style="font-size: 11px; color: #888; margin-left: 10px;" data-i18n="simple.randomTurnbackHint">(fait demi-tour alÃ©atoirement dans la zone)</span>
            </div>
          </div>

          <!-- ===== 3. End Pause ===== -->
          <div style="background: #fff8e6; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
            <div class="speed-control-inline mb-5">
              <label style="font-size: 13px; margin-right: 10px;">
                <input type="checkbox" id="endPauseEnabled" style="margin-right: 5px;">
                <strong>â¸ï¸ <span data-i18n="simple.endPause">Pause aux extrÃ©mitÃ©s</span></strong>
              </label>
              <label style="margin-left: 15px; font-size: 13px;">
                <input type="radio" name="endPauseMode" value="fixed" id="endPauseModeFixed" checked style="margin-right: 3px;">
                <span data-i18n="simple.endPauseModeFixed">Fixe</span>
              </label>
              <label style="margin-left: 10px; font-size: 13px;">
                <input type="radio" name="endPauseMode" value="random" id="endPauseModeRandom" style="margin-right: 3px;">
                <span data-i18n="simple.endPauseModeRandom">AlÃ©atoire</span>
              </label>
            </div>
            
            <!-- Fixed Duration -->
            <div id="endPauseFixedControls" class="speed-control-inline" style="margin-top: 8px;">
              <label class="label-inline" style="min-width: 60px;" data-i18n="common.duration">DurÃ©e:</label>
              <input type="number" id="endPauseDuration" min="0.1" max="30" step="0.1" value="1.0" class="input-compact" style="width: 60px;">
              <span class="unit-label">s</span>
              <button class="preset-btn-sm btn-preset" data-end-pause="0.5">0.5s</button>
              <button class="preset-btn-sm btn-preset active" data-end-pause="1">1s</button>
              <button class="preset-btn-sm btn-preset" data-end-pause="2">2s</button>
              <button class="preset-btn-sm btn-preset" data-end-pause="5">5s</button>
            </div>
            
            <!-- Random Min/Max -->
            <div id="endPauseRandomControls" class="hidden" style="margin-top: 8px;">
              <div class="speed-control-inline">
                <label class="label-inline" style="min-width: 60px;">Min:</label>
                <input type="number" id="endPauseMin" min="0.1" max="30" step="0.1" value="0.5" class="input-compact" style="width: 60px;">
                <span class="unit-label">s</span>
                <span style="margin-left: 15px; font-size: 13px;">Max:</span>
                <input type="number" id="endPauseMax" min="0.1" max="30" step="0.1" value="2.0" class="input-compact" style="width: 60px; margin-left: 5px;">
                <span class="unit-label">s</span>
              </div>
            </div>
          </div>
          
          <!-- Canvas Preview -->
          <canvas id="zoneEffectPreview" class="canvas-compact" width="300" height="100"></canvas>
        </div>
      </div>

      <!-- ===== CYCLE PAUSE SECTION ===== -->
      <div class="section-collapsible collapsed" style="margin-bottom: 20px;">
        <div class="section-collapsible-header" onclick="toggleCyclePauseSection()">
          <span class="collapse-icon">â–¼</span> <span id="cyclePauseHeaderText" data-i18n="simple.cyclePauseDisabled">â¸ï¸ Pause entre cycles - dÃ©sactivÃ©e</span>
        </div>
        
        <div class="section-collapsible-content">
          <!-- Mode Selection: Fixed / Random -->
          <div class="speed-control-inline" style="margin-bottom: 15px;">
            <label class="label-inline">Mode:</label>
            <label style="margin-right: 15px; font-size: 13px;">
              <input type="radio" name="cyclePauseMode" value="fixed" id="pauseModeFixed" checked style="margin-right: 5px;">
              â±ï¸ <span data-i18n="common.fixed">Fixe</span>
            </label>
            <label style="font-size: 13px;">
              <input type="radio" name="cyclePauseMode" value="random" id="pauseModeRandom" style="margin-right: 5px;">
              ğŸ² <span data-i18n="common.random">AlÃ©atoire</span>
            </label>
          </div>
          
          <!-- Fixed Mode: Single Duration -->
          <div id="pauseFixedControls" class="speed-control-inline mb-10">
            <label class="label-inline" data-i18n="common.duration">DurÃ©e:</label>
            <input type="number" id="cyclePauseDuration" min="0.1" max="60" step="0.1" value="1.5" class="input-compact">
            <span class="unit-label">s</span>
            <button class="preset-btn-sm btn-preset" data-pause-duration="0.1">0.1s</button>
            <button class="preset-btn-sm btn-preset" data-pause-duration="0.5">0.5s</button>
            <button class="preset-btn-sm btn-preset active" data-pause-duration="1.5">1.5s</button>
            <button class="preset-btn-sm btn-preset" data-pause-duration="3">3s</button>
            <button class="preset-btn-sm btn-preset" data-pause-duration="5">5s</button>
            <button class="preset-btn-sm btn-preset" data-pause-duration="10">10s</button>
          </div>
          
          <!-- Random Mode: Min/Max Range -->
          <div id="pauseRandomControls" class="hidden">
            <div class="speed-control-inline mb-10">
              <label class="label-inline">Min:</label>
              <input type="number" id="cyclePauseMin" min="0.1" max="60" step="0.1" value="1.5" class="input-compact">
              <span class="unit-label">s</span>
              <button class="preset-btn-sm btn-preset" data-pause-min="0.1">0.1s</button>
              <button class="preset-btn-sm btn-preset" data-pause-min="0.5">0.5s</button>
              <button class="preset-btn-sm btn-preset active" data-pause-min="1.5">1.5s</button>
              <button class="preset-btn-sm btn-preset" data-pause-min="3">3s</button>
            </div>
            
            <div class="speed-control-inline mb-10">
              <label class="label-inline">Max:</label>
              <input type="number" id="cyclePauseMax" min="0.1" max="60" step="0.1" value="5.0" class="input-compact">
              <span class="unit-label">s</span>
              <button class="preset-btn-sm btn-preset" data-pause-max="3">3s</button>
              <button class="preset-btn-sm btn-preset active" data-pause-max="5">5s</button>
              <button class="preset-btn-sm btn-preset" data-pause-max="10">10s</button>
              <button class="preset-btn-sm btn-preset" data-pause-max="15">15s</button>
            </div>
          </div>
          
          <!-- Real-time Pause Indicator -->
          <div id="cyclePauseStatus" style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 13px; text-align: center; display: none;">
            <strong>â±ï¸ <span data-i18n="simple.inPause">En pause:</span></strong> <span id="cyclePauseRemaining">0.0s</span> <span data-i18n="simple.remaining">restantes</span>
          </div>
        </div>
      </div>

    <div class="button-group">
      <button class="button btn-success" id="btnStart">â–¶ <span data-i18n="common.start">DÃ©marrer</span></button>
      <button class="button btn-warning" id="btnPause">â¸ <span data-i18n="common.pause">Pause</span></button>
      <button class="button btn-danger" id="btnStop">â¹ <span data-i18n="common.stop">ArrÃªter</span></button>
      <button class="button btn-info" id="btnManagePlaylistSimple">
        ğŸ“‹ Playlist (0/20)
      </button>
    </div>
    

    </div>
    </div>
    <!-- END MODE SIMPLE -->

    <!-- MODE POURSUITE Tab Content -->
    <div class="tab-content hidden-until-calibrated" id="tabPursuit">
      <div class="controls">
        
        <!-- Pursuit Controls -->
        <div style="display: flex; gap: 30px; align-items: flex-start; margin-bottom: 20px;">
          
          <!-- Left Side: Gauge -->
          <div style="flex: 0 0 200px;">
            <div style="text-align: center; margin-bottom: 10px;">
              <strong style="color: #333;" data-i18n="pursuit.gaugeTitle">Jauge de Position</strong>
            </div>
            
            <!-- Gauge Container -->
            <div id="gaugeContainer" style="position: relative; width: 120px; height: 500px; margin: 0 auto; background: linear-gradient(180deg, #f44336 0%, #FF9800 20%, #FFC107 40%, #4CAF50 60%, #2196F3 80%, #9C27B0 100%); border: 3px solid #333; border-radius: 10px; cursor: crosshair; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
              
              <!-- Target Cursor (user control) -->
              <div id="gaugeCursor" style="position: absolute; left: -5px; right: -5px; height: 8px; background: #FF5722; border: 3px solid white; border-radius: 4px; cursor: grab; box-shadow: 0 2px 8px rgba(0,0,0,0.5); transition: top 0.05s linear; z-index: 10;">
                <div style="position: absolute; right: -60px; top: -8px; background: #FF5722; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;" data-i18n="pursuit.target">
                  CIBLE
                </div>
              </div>
              
              <!-- Current Position Indicator -->
              <div id="gaugePosition" style="position: absolute; left: 0; right: 0; height: 6px; background: #00E676; border: 2px solid white; border-radius: 3px; box-shadow: 0 2px 8px rgba(0,255,118,0.6); transition: top 0.1s linear; z-index: 5;">
                <div style="position: absolute; left: -60px; top: -8px; background: #00E676; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap;" data-i18n="pursuit.actual">
                  RÃ‰EL
                </div>
              </div>
              
              <!-- Software Limit Line (dynamically positioned if limit < 100%) -->
              <div id="gaugeLimitLine" style="position: absolute; left: -8px; right: -8px; height: 3px; background: #000; border-top: 2px dashed #FF5722; display: none; z-index: 15;">
                <div style="position: absolute; right: -90px; top: -10px; background: #000; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; white-space: nowrap;">
                  ğŸš« <span data-i18n="pursuit.softLimit">LIMITE</span>
                </div>
              </div>
              
              <!-- Scale markers -->
              <div style="position: absolute; right: -40px; top: 0; height: 100%; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; color: #666;">
                <span data-i18n="pursuit.scaleEnd">FIN â–¶</span>
                <span>75% â–¶</span>
                <span>50% â–¶</span>
                <span>25% â–¶</span>
                <span data-i18n="pursuit.scaleStart">0mm â–¶</span>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
              <div><strong data-i18n="pursuit.targetLabel">Cible:</strong> <span id="targetPositionMM" style="color: #FF5722;">0.0</span> mm</div>
              <div><strong data-i18n="pursuit.actualLabel">Actuel:</strong> <span id="currentPositionMM" style="color: #00E676;">0.0</span> mm</div>
              <div><strong data-i18n="pursuit.errorLabel">Ã‰cart:</strong> <span id="positionError" class="text-muted">0.0</span> mm</div>
            </div>
          </div>
          
          <!-- Right Side: Settings -->
          <div style="flex: 1;">
            <!-- Checkbox Activer - COMPACT -->
            <div style="padding: 10px 15px; background: #E3F2FD; border-radius: 6px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="pursuitActiveCheckbox" autocomplete="off">
                <span style="font-weight: 600; color: #5a67d8;">ğŸ¯ <span data-i18n="pursuit.enablePursuit">Activer poursuite</span></span>
              </label>
              <small style="color: #666; display: block; margin-top: 4px; font-size: 11px; padding-left: 28px;">
                âš ï¸ <span data-i18n="pursuit.enablePursuitWarn">Le moteur suivra automatiquement le curseur</span>
              </small>
            </div>
            
            <!-- Vitesse max - COMPACT -->
            <div class="form-group-compact d-block">
              <div>
                <label class="label-inline" data-i18n="pursuit.maxSpeed">Vitesse max:</label>
                <input type="number" id="pursuitMaxSpeed" min="0.5" max="20" step="0.5" value="10" class="input-compact">
                <span class="unit-label">(0-20)</span>
              </div>
              <div class="mt-8">
                <button class="preset-btn-sm btn-preset" data-pursuit-speed="2">2ğŸŒ</button>
                <button class="preset-btn-sm btn-preset" data-pursuit-speed="5">5</button>
                <button class="preset-btn-sm btn-preset active" data-pursuit-speed="10">10âœ“</button>
                <button class="preset-btn-sm btn-preset" data-pursuit-speed="15">15</button>
                <button class="preset-btn-sm btn-preset" data-pursuit-speed="20">20âš¡</button>
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="button btn-success" id="btnActivatePursuit">â–¶ <span data-i18n="common.start">DÃ©marrer</span></button>
          <button class="button btn-danger" id="btnStopPursuit">â¹ <span data-i18n="common.stop">ArrÃªter</span></button>
        </div>
      </div>
    </div>
    <!-- END MODE POURSUITE -->

    <!-- MODE OSCILLATION Tab Content -->
    <div class="tab-content hidden-until-calibrated" id="tabOscillation">
      <div class="controls">
        
        <!-- Help Section (masquÃ©e par dÃ©faut) -->
        <div id="oscHelpSection" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px; font-size: 12px;">
          <strong style="color: #856404;">ğŸ’¡ <span data-i18n="oscillation.helpTitle">Conseils d'utilisation:</span></strong>
          <ul style="margin: 8px 0 0 20px; color: #856404;">
            <li data-i18n-html="oscillation.helpSine"><strong>Forme sinusoÃ¯dale:</strong> Mouvement fluide et doux, idÃ©al pour tests mÃ©caniques (comme une vague ğŸŒŠ)</li>
            <li data-i18n-html="oscillation.helpTriangle"><strong>Forme triangle:</strong> AccÃ©lÃ©ration/dÃ©cÃ©lÃ©ration linÃ©aire constante (mouvement mÃ©canique)</li>
            <li data-i18n-html="oscillation.helpSquare"><strong>Forme carrÃ©e:</strong> Changements de direction instantanÃ©s (attention aux contraintes mÃ©caniques!)</li>
            <li data-i18n-html="oscillation.helpRamps"><strong>Rampes:</strong> Ã‰vitent les Ã -coups au dÃ©marrage/arrÃªt en augmentant/rÃ©duisant progressivement l'amplitude</li>
            <li data-i18n-html="oscillation.helpAutoLimits"><strong>Limites auto:</strong> L'amplitude est automatiquement limitÃ©e aux bornes calibrÃ©es</li>
            <li data-i18n-html="oscillation.helpRealtime"><strong>Modification temps rÃ©el:</strong> Vous pouvez changer les paramÃ¨tres pendant l'oscillation!</li>
          </ul>
        </div>

        <!-- Configuration principale - COMPACT -->
        <div class="form-row-compact">
          <!-- Centre -->
          <div class="form-group-compact d-block">
            <div>
              <label class="label-inline">Centre:</label>
              <input type="number" id="oscCenter" min="0" step="1" value="0" class="input-compact">
              <span class="unit-label">mm</span>
            </div>
            <div class="mt-8">
              <button class="preset-btn-sm btn-preset" data-osc-center="25">25mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-center="50">50mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-center="75">75mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-center="110">110mm</button>
            </div>
            <div class="mt-4">
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="-20">-20</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="-10">-10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="-5">-5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="+5">+5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="+10">+10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-center-rel="+20">+20</button>
            </div>
          </div>
          
          <!-- Amplitude -->
          <div class="form-group-compact d-block">
            <div>
              <label class="label-inline">Amplitude Â±:</label>
              <input type="number" id="oscAmplitude" min="1" step="1" value="20" class="input-compact">
              <span class="unit-label">mm</span>
              <label style="margin-left: 10px; display: inline; font-size: 11px; cursor: pointer;" data-i18n-title="oscillation.amplitudeLinkedTooltip" title="Si cochÃ©, amplitude = centre (liÃ©s)">
                <input type="checkbox" id="oscAmplitudeLinked" style="margin-right: 4px;">
                <span data-i18n="oscillation.amplitudeLinked">=Centre</span>
              </label>
            </div>
            <div class="mt-8">
              <button class="preset-btn-sm btn-preset" data-osc-amplitude="10">10mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-amplitude="25">25mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-amplitude="50">50mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-amplitude="75">75mm</button>
              <button class="preset-btn-sm btn-preset" data-osc-amplitude="100">100mm</button>
            </div>
            <div class="mt-4">
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="-20">-20</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="-10">-10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="-5">-5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="+5">+5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="+10">+10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-osc-amplitude-rel="+20">+20</button>
            </div>
          </div>
        </div>
        
        <!-- Warning limite (compact) -->
        <div id="oscLimitWarning" style="display:none; color: #f56565; font-size: 12px; padding: 5px 10px; background: rgba(245,101,101,0.08); border-radius: 8px; margin-bottom: 10px;">
          âš ï¸ <span data-i18n="oscillation.limitWarning">Limites dÃ©passÃ©es! Ajuster centre ou amplitude.</span>
        </div>
        
        <!-- SÃ©parateur -->
        <div class="divider"></div>
        
        <!-- Forme + FrÃ©quence inline -->
        <div class="speed-control-inline mb-12">
          <label class="label-inline" data-i18n="oscillation.waveform">Forme:</label>
          <select id="oscWaveform" style="width: 150px; padding: 5px; font-size: 12px; border: 2px solid #ddd; border-radius: 4px;">
            <option value="0" data-i18n="oscillation.waveformSine">SinusoÃ¯dale</option>
            <option value="1" data-i18n="oscillation.waveformTriangle">Triangle</option>
            <option value="2" data-i18n="oscillation.waveformSquare">CarrÃ©e</option>
          </select>
          <label class="label-inline" style="margin-left: 15px;" data-i18n="oscillation.frequency">FrÃ©quence:</label>
          <input type="number" id="oscFrequency" min="0.01" max="10" step="0.01" value="0.5" class="input-compact">
          <span class="unit-label">Hz</span>
          <button class="preset-btn-sm btn-preset" data-osc-frequency="0.1">0.1Hz</button>
          <button class="preset-btn-sm btn-preset" data-osc-frequency="0.25">0.25Hz</button>
          <button class="preset-btn-sm btn-preset" data-osc-frequency="0.5">0.5Hz</button>
          <button class="preset-btn-sm btn-preset" data-osc-frequency="1">1Hz</button>
          <button class="preset-btn-sm btn-preset" data-osc-frequency="2">2Hz</button>
        </div>
        
        <!-- SÃ©parateur -->
        <div class="divider"></div>

        <!-- Rampes inline (pas d'accordion) -->
        <div class="speed-control-inline mb-10">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="oscRampInEnable" checked style="width: auto; margin-right: 5px;">
            <span class="text-md" data-i18n="oscillation.rampIn">Rampe entrÃ©e:</span>
          </label>
          <input type="number" id="oscRampInDuration" min="100" step="100" value="2000" class="input-compact" style="width: 70px;">
          <span class="unit-label">ms</span>
          
          <label style="display: flex; align-items: center; cursor: pointer; margin-left: 20px;">
            <input type="checkbox" id="oscRampOutEnable" checked style="width: auto; margin-right: 5px;">
            <span class="text-md" data-i18n="oscillation.rampOut">Rampe sortie:</span>
          </label>
          <input type="number" id="oscRampOutDuration" min="100" step="100" value="2000" class="input-compact" style="width: 70px;">
          <span class="unit-label">ms</span>
        </div>
        
        <!-- Cycles + Retour centre inline -->
        <div class="speed-control-inline mb-12">
          <label class="label-inline">Cycles:</label>
          <input type="number" id="oscCycleCount" min="0" step="1" value="0" class="input-compact" style="width: 60px;">
          <span class="unit-label" style="font-size: 11px;" data-i18n="oscillation.cyclesInfinite">(0=Infini)</span>
          
          <label style="display: flex; align-items: center; cursor: pointer; margin-left: 20px;">
            <input type="checkbox" id="oscReturnCenter" checked style="width: auto; margin-right: 5px;">
            <span class="text-md" data-i18n="oscillation.returnCenter">Retour centre</span>
          </label>
        </div>
        
        <!-- SÃ©parateur -->
        <div class="divider"></div>

        <!-- Ã‰tat temps rÃ©el - COMPACT -->
        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
            <div>
              <strong>Amplitude:</strong>
              <span id="oscCurrentAmplitude" style="color: #f5576c; font-weight: bold;">--</span> mm
            </div>
            <div>
              <strong>Cycles:</strong>
              <span id="oscCompletedCycles" style="color: #f5576c; font-weight: bold;">0</span>
            </div>
            <div>
              <strong>Rampe:</strong>
              <span id="oscRampStatus" class="text-muted">--</span>
            </div>
            <div>
              <strong>Limites:</strong>
              <span id="oscLimitStatus" style="font-weight: bold;">--</span>
            </div>
          </div>
        </div>
        
        <!-- ===== CYCLE PAUSE SECTION (OSCILLATION) ===== -->
        <div class="section-collapsible collapsed" style="margin-bottom: 20px;">
          <div class="section-collapsible-header" onclick="toggleCyclePauseOscSection()">
            <span class="collapse-icon">â–¼</span> <span id="cyclePauseOscHeaderText" data-i18n="oscillation.cyclePauseDisabled">â¸ï¸ Pause entre cycles - dÃ©sactivÃ©e</span>
          </div>
          
          <div class="section-collapsible-content">
            <!-- Mode Selection: Fixed / Random -->
            <div class="speed-control-inline" style="margin-bottom: 15px;">
              <label class="label-inline">Mode:</label>
              <label style="margin-right: 15px; font-size: 13px;">
                <input type="radio" name="cyclePauseModeOsc" value="fixed" id="pauseModeFixedOsc" checked style="margin-right: 5px;">
                â±ï¸ <span data-i18n="common.fixed">Fixe</span>
              </label>
              <label style="font-size: 13px;">
                <input type="radio" name="cyclePauseModeOsc" value="random" id="pauseModeRandomOsc" style="margin-right: 5px;">
                ğŸ² <span data-i18n="common.random">AlÃ©atoire</span>
              </label>
            </div>
            
            <!-- Fixed Mode: Single Duration -->
            <div id="pauseFixedControlsOsc" class="speed-control-inline mb-10">
              <label class="label-inline" data-i18n="common.duration">DurÃ©e:</label>
              <input type="number" id="cyclePauseDurationOsc" min="0.1" max="60" step="0.1" value="1.5" class="input-compact">
              <span class="unit-label">s</span>
              <button class="preset-btn-sm btn-preset" data-pause-duration-osc="0.1">0.1s</button>
              <button class="preset-btn-sm btn-preset" data-pause-duration-osc="0.5">0.5s</button>
              <button class="preset-btn-sm btn-preset active" data-pause-duration-osc="1.5">1.5s</button>
              <button class="preset-btn-sm btn-preset" data-pause-duration-osc="3">3s</button>
              <button class="preset-btn-sm btn-preset" data-pause-duration-osc="5">5s</button>
              <button class="preset-btn-sm btn-preset" data-pause-duration-osc="10">10s</button>
            </div>
            
            <!-- Random Mode: Min/Max Range -->
            <div id="pauseRandomControlsOsc" class="hidden">
              <div class="speed-control-inline mb-10">
                <label class="label-inline">Min:</label>
                <input type="number" id="cyclePauseMinOsc" min="0.1" max="60" step="0.1" value="1.5" class="input-compact">
                <span class="unit-label">s</span>
                <button class="preset-btn-sm btn-preset" data-pause-min-osc="0.1">0.1s</button>
                <button class="preset-btn-sm btn-preset" data-pause-min-osc="0.5">0.5s</button>
                <button class="preset-btn-sm btn-preset active" data-pause-min-osc="1.5">1.5s</button>
                <button class="preset-btn-sm btn-preset" data-pause-min-osc="3">3s</button>
              </div>
              
              <div class="speed-control-inline mb-10">
                <label class="label-inline">Max:</label>
                <input type="number" id="cyclePauseMaxOsc" min="0.1" max="60" step="0.1" value="5.0" class="input-compact">
                <span class="unit-label">s</span>
                <button class="preset-btn-sm btn-preset" data-pause-max-osc="3">3s</button>
                <button class="preset-btn-sm btn-preset active" data-pause-max-osc="5">5s</button>
                <button class="preset-btn-sm btn-preset" data-pause-max-osc="10">10s</button>
                <button class="preset-btn-sm btn-preset" data-pause-max-osc="15">15s</button>
              </div>
            </div>
            
            <!-- Real-time Pause Indicator -->
            <div id="cyclePauseStatusOsc" style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 13px; text-align: center; display: none;">
              <strong>â±ï¸ <span data-i18n="simple.inPause">En pause:</span></strong> <span id="cyclePauseRemainingOsc">0.0s</span> <span data-i18n="simple.remaining">restantes</span>
            </div>
          </div>
        </div>
        
        <!-- Boutons de contrÃ´le (comme Simple - en bas) -->
        <div class="button-group">
          <button class="button btn-success" id="btnStartOscillation">â–¶ï¸ <span data-i18n="common.start">DÃ©marrer</span></button>
          <button class="button btn-warning" id="btnPauseOscillation">â¸ <span data-i18n="common.pause">Pause</span></button>
          <button class="button btn-danger" id="btnStopOscillation">â¹ï¸ <span data-i18n="common.stop">ArrÃªter</span></button>
          <button class="button btn-info" id="btnManagePlaylistOscillation">
            ğŸ“‹ Playlist (0/20)
          </button>
          <button class="button btn-help" onclick="toggleOscHelp()" style="padding: 12px 20px;">â“</button>
        </div>
        

      </div>
    </div>
    <!-- END MODE OSCILLATION -->

    <!-- MODE CHAOS Tab Content -->
    <div class="tab-content hidden-until-calibrated" id="tabChaos">
      <div class="controls">
        
        <!-- Help Section (masquÃ©e par dÃ©faut) -->
        <div id="chaosHelpSection" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 15px; border-radius: 4px; font-size: 12px;">
          <strong style="color: #856404;">ğŸ’¡ <span data-i18n="chaos.helpTitle">Patterns Chaos (11 patterns):</span></strong>
          <p style="margin: 8px 0 0 0; color: #856404; font-weight: bold;">ğŸŒŠ <span data-i18n="chaos.helpSoftTitle">Patterns DOUX (mouvements continus - 45%):</span></p>
          <ul style="margin: 5px 0 10px 20px; color: #856404;">
            <li data-i18n-html="chaos.helpWave"><strong>WAVE:</strong> Vagues lentes et continues, fluide, 25-75% vitesse, 4-8s</li>
            <li data-i18n-html="chaos.helpPendulum"><strong>PENDULUM:</strong> Balancier rÃ©gulier, oscillations douces, 30-90% vitesse, 3-6s</li>
            <li data-i18n-html="chaos.helpSpiral"><strong>SPIRAL:</strong> Spirale progressive expansion/contraction, 20-75% vitesse, 5-10s</li>
            <li data-i18n-html="chaos.helpBreathing"><strong>BREATHING:</strong> Respiration apaisante, petites amplitudes 10-50%, pauses alÃ©atoires, 15-60% vitesse, 2-5s</li>
          </ul>
          <p style="margin: 8px 0 0 0; color: #856404; font-weight: bold;">âš¡ <span data-i18n="chaos.helpDynamicTitle">Patterns DYNAMIQUES (sauts de position - 55%):</span></p>
          <ul style="margin: 5px 0 10px 20px; color: #856404;">
            <li data-i18n-html="chaos.helpZigzag"><strong>ZIGZAG:</strong> Va-et-vient modÃ©rÃ©s, sauts max 60%, 40-100% vitesse, 1-2.5s</li>
            <li data-i18n-html="chaos.helpSweep"><strong>SWEEP:</strong> Balayages bout-Ã -bout, 30-90% vitesse, 2-4s</li>
            <li data-i18n-html="chaos.helpPulse"><strong>PULSE:</strong> Impulsions depuis centre Â±40%, 50-100% vitesse, 0.8-1.5s</li>
            <li data-i18n-html="chaos.helpDrift"><strong>DRIFT:</strong> DÃ©rive micro-changements 25%, 20-70% vitesse, 3-6s</li>
            <li data-i18n-html="chaos.helpBurst"><strong>BURST:</strong> Sauts ultrarapides 70%, 60-100% vitesse, 0.6-1.2s</li>
            <li data-i18n-html="chaos.helpBruteForce"><strong>BRUTE FORCE:</strong> BÃ©lier 3 phases: entrÃ©e rapide 70-100%, sortie lente 20-30%, pause 200-1500ms</li>
            <li data-i18n-html="chaos.helpLiberator"><strong>LIBERATOR:</strong> Extraction 3 phases: entrÃ©e lente 20-30%, sortie rapide 70-100%, pause 200-1500ms</li>
          </ul>
          <p style="margin: 8px 0 0 0; color: #856404;">
            âœ¨ <strong data-i18n="chaos.helpSummary">45% doux, 55% dynamiques. DegrÃ© de folie module vitesse/durÃ©e/sauts/pauses.</strong>
          </p>
        </div>

        <!-- Configuration principale -->
        <div class="form-row-compact">
          <div class="form-group-compact d-block">
            <div>
              <label class="label-inline">Centre:</label>
              <input type="number" id="chaosCenterPos" min="0" step="1" value="110" class="input-compact">
              <span class="unit-label">mm</span>
            </div>
            <div class="mt-8">
              <button class="preset-btn-sm btn-preset" data-chaos-center="25">25mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-center="50">50mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-center="75">75mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-center="110">110mm</button>
            </div>
            <div class="mt-4">
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="-20">-20</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="-10">-10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="-5">-5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="+5">+5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="+10">+10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-center-rel="+20">+20</button>
            </div>
          </div>
          <div class="form-group-compact d-block">
            <div>
              <label class="label-inline">Amplitude Â±:</label>
              <input type="number" id="chaosAmplitude" min="1" step="1" value="50" class="input-compact">
              <span class="unit-label">mm</span>
              <label style="margin-left: 10px; display: inline; font-size: 11px; cursor: pointer;" data-i18n-title="chaos.amplitudeLinkedTooltip" title="Si cochÃ©, amplitude = centre (liÃ©s)">
                <input type="checkbox" id="chaosAmplitudeLinked" style="margin-right: 4px;">
                <span data-i18n="chaos.amplitudeLinked">=Centre</span>
              </label>
            </div>
            <div class="mt-8">
              <button class="preset-btn-sm btn-preset" data-chaos-amplitude="10">10mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-amplitude="25">25mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-amplitude="50">50mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-amplitude="75">75mm</button>
              <button class="preset-btn-sm btn-preset" data-chaos-amplitude="100">100mm</button>
            </div>
            <div class="mt-4">
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="-20">-20</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="-10">-10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="-5">-5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="+5">+5</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="+10">+10</button>
              <button class="preset-btn-sm btn-preset btn-relative" data-chaos-amplitude-rel="+20">+20</button>
            </div>
          </div>
        </div>

        <!-- SÃ©parateur -->
        <div class="divider"></div>

        <!-- Vitesse max -->
        <div class="speed-control-inline mb-12">
          <label class="label-inline" data-i18n="chaos.maxSpeed">Vitesse max:</label>
          <input type="number" id="chaosMaxSpeed" min="0.5" max="20" step="0.5" value="10" class="input-compact">
          <button class="preset-btn-sm btn-preset" data-chaos-speed="0.5">0.5 ğŸŒ</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="1">1</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="2">2</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="5">5 âœ“</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="10">10</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="15">15</button>
          <button class="preset-btn-sm btn-preset" data-chaos-speed="20">20 âš¡</button>
        </div>

        <!-- DegrÃ© de folie -->
        <div class="speed-control-inline mb-12">
          <label class="label-inline">ğŸ”¥ <span data-i18n="chaos.craziness">DegrÃ© folie:</span> <span id="crazinessValue" style="font-weight: bold; color: #C850C0;">50</span>%</label>
          <input type="range" id="chaosCraziness" min="0" max="100" step="5" value="50" style="width: 180px; margin-left: 10px;">
          <button class="preset-btn-sm btn-preset" data-chaos-craziness="0">0% ğŸ˜´</button>
          <button class="preset-btn-sm btn-preset" data-chaos-craziness="25">25%</button>
          <button class="preset-btn-sm btn-preset" data-chaos-craziness="50">50% âœ“</button>
          <button class="preset-btn-sm btn-preset" data-chaos-craziness="75">75%</button>
          <button class="preset-btn-sm btn-preset" data-chaos-craziness="100">100% ğŸ”¥</button>
        </div>

        <!-- DurÃ©e -->
        <div class="speed-control-inline mb-12">
          <label class="label-inline" data-i18n="chaos.duration">DurÃ©e:</label>
          <input type="number" id="chaosDuration" min="0" step="1" value="0" class="input-compact" style="width: 70px;">
          <span class="unit-label" data-i18n="chaos.durationInfinite">s (0=Infini)</span>
          <button class="preset-btn-sm btn-preset" data-chaos-duration="30">30s</button>
          <button class="preset-btn-sm btn-preset" data-chaos-duration="60">60s</button>
          <button class="preset-btn-sm btn-preset" data-chaos-duration="120">120s</button>
          <button class="preset-btn-sm btn-preset" data-chaos-duration="0">âˆ</button>
        </div>

        <!-- SÃ©parateur -->
        <div class="divider"></div>

        <!-- Accordion: Options avancÃ©es -->
        <div class="section-collapsible collapsed" id="chaosAdvancedSection">
          <div class="section-collapsible-header" onclick="toggleChaosAdvancedSection()">
            <span class="collapse-icon">â–¼</span> <span id="chaosAdvancedHeaderText" data-i18n="chaos.advancedOptions">âš™ï¸ Options avancÃ©es</span>
          </div>
          <div class="section-collapsible-content">
          
          <!-- Patterns actifs -->
          <div style="padding: 10px; background: rgba(72,187,120,0.08); border-radius: 8px; border-left: 3px solid #48bb78;">
            <label style="font-weight: bold; font-size: 12px; display: block; margin-bottom: 8px;">âœ… <span data-i18n="chaos.activePatterns">Patterns actifs:</span></label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px;">
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternWave" checked class="chaos-pattern-checkbox">
                <span>ğŸŒŠ WAVE</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternPendulum" checked class="chaos-pattern-checkbox">
                <span>ğŸ¯ PENDULUM</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternSpiral" checked class="chaos-pattern-checkbox">
                <span>ğŸŒ€ SPIRAL</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternZigzag" checked class="chaos-pattern-checkbox">
                <span>âš¡ ZIGZAG</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternSweep" checked class="chaos-pattern-checkbox">
                <span>â†”ï¸ SWEEP</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternPulse" checked class="chaos-pattern-checkbox">
                <span>ğŸ’« PULSE</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternDrift" checked class="chaos-pattern-checkbox">
                <span>ğŸŒ«ï¸ DRIFT</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternBurst" checked class="chaos-pattern-checkbox">
                <span>ğŸ”¥ BURST</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternCalm" checked class="chaos-pattern-checkbox">
                <span>ğŸ˜Œ BREATHING</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternBruteForce" checked class="chaos-pattern-checkbox">
                <span>ğŸ”¨ BRUTE FORCE</span>
              </label>
              <label class="chaos-pattern-label">
                <input type="checkbox" id="patternLiberator" checked class="chaos-pattern-checkbox">
                <span>ğŸ”“ LIBERATOR</span>
              </label>
            </div>
            <div style="display: flex; gap: 5px; margin-top: 8px;">
              <button class="preset-btn-sm btn-preset" id="btnEnableAllPatterns" style="flex: 1; font-size: 10px; padding: 4px;">âœ… <span data-i18n="chaos.allPatterns">Tout</span></button>
              <button class="preset-btn-sm btn-preset" id="btnEnableSoftPatterns" style="flex: 1; font-size: 10px; padding: 4px;">ğŸŒŠ <span data-i18n="chaos.softPatterns">Doux</span></button>
              <button class="preset-btn-sm btn-preset" id="btnEnableDynamicPatterns" style="flex: 1; font-size: 10px; padding: 4px;">âš¡ <span data-i18n="chaos.dynamicPatterns">Dynamiques</span></button>
            </div>
          </div>

          <!-- Seed (optionnel) -->
          <div style="margin-top: 10px;">
            <label class="label-inline text-md" data-i18n="chaos.seed">Seed (optionnel):</label>
            <input type="number" id="chaosSeed" min="0" step="1" value="0" class="input-compact" style="width: 90px;">
            <span class="unit-label" style="font-size: 11px;" data-i18n="chaos.seedHint">(0=alÃ©atoire)</span>
          </div>
          </div>
        </div>

        <!-- SÃ©parateur -->
        <div class="divider"></div>

        <!-- Real-time Stats Section -->
        <div id="chaosStats" style="display: none; background: #e3f2fd; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
            <div><strong data-i18n="chaos.pattern">Pattern:</strong> <span id="statPattern" style="color: #C850C0;">--</span></div>
            <div><strong data-i18n="common.position">Position:</strong> <span id="statPosition" style="color: #667eea;">--</span> mm</div>
            <div><strong data-i18n="chaos.range">Plage:</strong> <span id="statRange" style="color: #667eea;">--</span> mm</div>
            <div><strong data-i18n="chaos.patterns">Patterns:</strong> <span id="statCount" style="color: #667eea;">0</span></div>
          </div>
          <div id="statTimer" style="margin-top: 8px; text-align: center; font-size: 12px;">
            â±ï¸ <span data-i18n="chaos.time">Temps:</span> <span id="statElapsed">0</span>s
          </div>
        </div>

        <!-- Boutons de contrÃ´le -->
        <div class="button-group">
          <button class="button btn-success" id="btnStartChaos">â–¶ï¸ <span data-i18n="common.start">DÃ©marrer</span></button>
          <button class="button btn-warning" id="btnPauseChaos">â¸ <span data-i18n="common.pause">Pause</span></button>
          <button class="button btn-danger" id="btnStopChaos">â¹ï¸ <span data-i18n="common.stop">ArrÃªter</span></button>
          <button class="button btn-info" id="btnManagePlaylistChaos">
            ğŸ“‹ Playlist (0/20)
          </button>
          <button class="button btn-help" onclick="toggleChaosHelp()" style="padding: 12px 20px;">â“</button>
        </div>
      </div>
    </div>
    <!-- END MODE CHAOS -->

    <!-- MODE SÃ©quenceur Tab Content -->
    <div class="tab-content hidden-until-calibrated" id="tabTableau">
      <div class="controls">
        
        <!-- Toolbar -->
        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
          <button class="button btn-success" id="btnAddLine" style="flex: 1; min-width: 110px; padding: 8px; font-size: 13px;">â• <span data-i18n="sequencer.addLine">Ajouter</span></button>
          <button class="button btn-warning" id="btnClearAll" style="flex: 1; min-width: 110px; padding: 8px; font-size: 13px;">ğŸ—‘ï¸ <span data-i18n="sequencer.clearAll">Effacer</span></button>
          <button class="button btn-primary" id="btnImportSeq" style="flex: 1; min-width: 110px; padding: 8px; font-size: 13px;">ğŸ“¥ <span data-i18n="sequencer.importBtn">Import</span></button>
          <button class="button btn-primary" id="btnExportSeq" style="flex: 1; min-width: 110px; padding: 8px; font-size: 13px;">ğŸ“¤ <span data-i18n="sequencer.exportBtn">Export</span></button>
          <button class="button btn-info" id="btnDownloadTemplate" style="flex: 1; min-width: 110px; padding: 8px; font-size: 13px; background: #17a2b8;" data-i18n-title="sequencer.templateTooltip" title="TÃ©lÃ©charger un template JSON avec exemples">ğŸ“„ <span data-i18n="sequencer.template">Template</span></button>
        </div>

        <!-- Phase 2: Batch Operations Toolbar (hidden by default) -->
        <div id="sequenceBatchToolbar" class="sequence-batch-toolbar">
          <div class="sequence-batch-info">
            <span id="batchSelectionCount" data-i18n="sequencer.linesSelected">0 ligne(s) sÃ©lectionnÃ©e(s)</span>
          </div>
          <div class="sequence-batch-actions">
            <button class="sequence-batch-btn" onclick="batchEnableLines(true)">
              <span>âœ“</span> <span data-i18n="sequencer.enable">Activer</span>
            </button>
            <button class="sequence-batch-btn" onclick="batchEnableLines(false)">
              <span>âœ—</span> <span data-i18n="sequencer.disable">DÃ©sactiver</span>
            </button>
            <div id="sequenceTrashZone" class="sequence-trash-zone">
              <span class="trash-icon">ğŸ—‘ï¸</span>
              <span data-i18n="sequencer.dragHere">Glisser ici</span>
            </div>
            <button class="sequence-batch-btn" onclick="clearSelection()">
              <span>âœ–</span> <span data-i18n="sequencer.cancelSelection">Annuler</span>
            </button>
          </div>
        </div>

        <!-- Sequence Table Container -->
        <div class="seq-table-container">
          <table id="sequenceTable" class="seq-table">
            <thead>
              <tr class="seq-thead-row">
                <th class="seq-th" style="width: 30px;">âœ“</th>
                <th class="seq-th" style="width: 30px;">#</th>
                <th class="seq-th" style="width: 40px;">Type</th>
                <th class="seq-th-wide"><span data-i18n="sequencer.startCol">DÃ©but</span><br><small>(mm)</small></th>
                <th class="seq-th-wide"><span data-i18n="sequencer.distCol">Dist.</span><br><small>(mm)</small></th>
                <th class="seq-th-wide"><span data-i18n="sequencer.speedCol">Vitesses</span><br><small data-i18n="sequencer.speedSubCol">A/R</small></th>
                <th class="seq-th-wide"><span data-i18n="sequencer.decelCol">DÃ©cel.</span></th>
                <th class="seq-th" style="width: 45px;">Cycles</th>
                <th class="seq-th" style="width: 50px;">â±ï¸<br><small>(s)</small></th>
                <th class="seq-th">Actions</th>
              </tr>
            </thead>
            <tbody id="sequenceTableBody">
              <tr>
                <td colspan="10" class="seq-empty-row">
                  <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“‹</div>
                  <div style="font-size: 16px;">Aucune ligne - Cliquez sur "â• Ajouter ligne" pour commencer</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Permanent Trash Drop Zone -->
        <div id="sequenceTrashDropZone" class="sequence-trash-drop-zone">
          <span class="trash-icon">ğŸ—‘ï¸</span>
          <span data-i18n="sequencer.trashDrop">Glisser une ligne ici pour la supprimer</span>
        </div>

        <!-- Execution Controls -->
        <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
            <button class="button btn-success" id="btnStartSequence" style="flex: 1; min-width: 130px; font-size: 14px; padding: 10px;">
              â–¶ï¸ <span data-i18n="sequencer.singleRun">Unique</span>
            </button>
            <button class="button btn-primary" id="btnLoopSequence" style="flex: 1; min-width: 130px; font-size: 14px; padding: 10px; background: linear-gradient(135deg,#ed8936,#dd6b20);">
              ğŸ” <span data-i18n="sequencer.loopRun">Boucle</span>
            </button>
            <button class="button btn-warning" id="btnPauseSequence" style="flex: 1; min-width: 90px; font-size: 14px; padding: 10px;" disabled>
              â¸ï¸ <span data-i18n="common.pause">Pause</span>
            </button>
            <button class="button btn-danger" id="btnStopSequence" style="flex: 1; min-width: 90px; font-size: 14px; padding: 10px;" disabled>
              â¹ï¸ <span data-i18n="common.stop">Stop</span>
            </button>
            <button class="button btn-primary" id="btnSkipLine" style="flex: 1; min-width: 110px; font-size: 14px; padding: 10px; background: #9C27B0;" disabled>
              â­ï¸ <span data-i18n="sequencer.skipLine">Suivant</span>
            </button>
          </div>

          <!-- Sequence Status - COMPACT -->
          <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 12px; padding: 10px 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
            <div><span class="text-muted" data-i18n="sequencer.modeLabel">Mode:</span> <strong id="seqMode" style="color: #333;" data-i18n="sequencer.stopped">ArrÃªtÃ©</strong></div>
            <div><span class="text-muted" data-i18n="sequencer.lineLabel">Ligne:</span> <strong id="seqCurrentLine" style="color: #667eea;">-- / --</strong></div>
            <div><span class="text-muted" data-i18n="sequencer.cycleLabel">Cycle:</span> <strong id="seqLineCycle" style="color: #48bb78;">--</strong></div>
            <div><span class="text-muted" data-i18n="sequencer.loopsLabel">Boucles:</span> <strong id="seqLoopCount" style="color: #ed8936;">0</strong></div>
            <div><span class="text-muted">â±ï¸ <span data-i18n="sequencer.pauseLabel">Pause:</span></span> <strong id="seqPauseRemaining" style="color: #9C27B0;">-- ms</strong></div>
          </div>
        </div>

      </div>
    </div>
    <!-- END MODE SÃ©quenceur -->

    <!-- Modal for Line Editing -->
    <div id="editLineModal" class="modal-overlay" onclick="closeEditLineModalOnOverlayClick(event)">
      <div class="modal-container" onclick="event.stopPropagation()">
        
        <!-- Modal Header -->
        <div class="modal-header">
          <h3>âœï¸ <span data-i18n="sequencer.editLineTitle">Ã‰diter la ligne #</span><span id="editLineNumber">--</span></h3>
          <button id="btnCloseModal" class="modal-close-btn">Ã—</button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <form id="editLineForm" novalidate>
            
            <!-- Movement Type Selection -->
            <div class="type-selection-row">
              <label class="label-inline">ğŸ›ï¸ <span data-i18n="sequencer.movementType">Type:</span></label>
              <div class="type-selection-buttons">
                <label class="radio-label-inline">
                  <input type="radio" name="movementType" id="editTypeVaet" value="0" checked style="width: auto;">
                  <span>ğŸ”„ <span data-i18n="sequencer.typeVaet">Va-et-vient</span></span>
                </label>
                <label class="radio-label-inline">
                  <input type="radio" name="movementType" id="editTypeOsc" value="1" style="width: auto;">
                  <span>ã€°ï¸ <span data-i18n="sequencer.typeOsc">Oscillation</span></span>
                </label>
                <label class="radio-label-inline">
                  <input type="radio" name="movementType" id="editTypeChaos" value="2" style="width: auto;">
                  <span>ğŸŒ€ <span data-i18n="sequencer.typeChaos">Chaos</span></span>
                </label>
                <label class="radio-label-inline">
                  <input type="radio" name="movementType" id="editTypeCalibration" value="4" style="width: auto;">
                  <span>ğŸ“ <span data-i18n="sequencer.typeCalibration">Calibration</span></span>
                </label>
              </div>
            </div>

            <!-- PLAYLIST PRESETS LOADING (for all modes) -->
            <div id="playlistLoaderSimple" style="background: rgba(102,126,234,0.06); padding: 12px; margin: 15px 0; border-radius: 10px; border: 1.5px solid rgba(102,126,234,0.2);">
              <label style="font-weight: 600; color: #5a67d8; display: block; margin-bottom: 8px;">ğŸ“‹ <span data-i18n="sequencer.loadPresetSimple">Charger un preset Simple:</span></label>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select id="editSimplePresetSelect" onchange="previewSequencerPreset('simple', this.value)" style="flex: 1; padding: 8px; border: 1.5px solid #e2e8f0; border-radius: 8px;">
                  <option value="" data-i18n="sequencer.selectPreset">-- SÃ©lectionner un preset --</option>
                </select>
                <button type="button" onclick="previewSequencerPreset('simple', document.getElementById('editSimplePresetSelect').value)" style="padding: 8px 12px; background: #64B5F6; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Voir les dÃ©tails">
                  ğŸ‘ï¸
                </button>
              </div>
              <button type="button" onclick="loadPresetIntoSequencerModal('simple')" style="width: 100%; padding: 8px; background: linear-gradient(135deg,#667eea,#5a67d8); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                â¬‡ï¸ <span data-i18n="sequencer.loadValues">Charger les valeurs</span>
              </button>
            </div>

            <div id="playlistLoaderOscillation" style="background: rgba(237,137,54,0.06); padding: 12px; margin: 15px 0; border-radius: 10px; border: 1.5px solid rgba(237,137,54,0.2); display: none;">
              <label style="font-weight: 500; color: #F57C00; display: block; margin-bottom: 8px;">ğŸ“‹ <span data-i18n="sequencer.loadPresetOsc">Charger un preset Oscillation:</span></label>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select id="editOscillationPresetSelect" onchange="previewSequencerPreset('oscillation', this.value)" style="flex: 1; padding: 8px; border: 1.5px solid #e2e8f0; border-radius: 8px;">
                  <option value="" data-i18n="sequencer.selectPreset">-- SÃ©lectionner un preset --</option>
                </select>
                <button type="button" onclick="previewSequencerPreset('oscillation', document.getElementById('editOscillationPresetSelect').value)" style="padding: 8px 12px; background: #FFB74D; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Voir les dÃ©tails">
                  ğŸ‘ï¸
                </button>
              </div>
              <button type="button" onclick="loadPresetIntoSequencerModal('oscillation')" style="width: 100%; padding: 8px; background: linear-gradient(135deg,#ed8936,#dd6b20); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                â¬‡ï¸ <span data-i18n="sequencer.loadValues">Charger les valeurs</span>
              </button>
            </div>

            <div id="playlistLoaderChaos" style="background: #FCE4EC; padding: 12px; margin: 15px 0; border-radius: 6px; border: 2px solid #E91E63; display: none;">
              <label style="font-weight: 500; color: #C2185B; display: block; margin-bottom: 8px;">ğŸ“‹ <span data-i18n="sequencer.loadPresetChaos">Charger un preset Chaos:</span></label>
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <select id="editChaosPresetSelect" onchange="previewSequencerPreset('chaos', this.value)" style="flex: 1; padding: 8px; border: 1px solid #E91E63; border-radius: 4px;">
                  <option value="" data-i18n="sequencer.selectPreset">-- SÃ©lectionner un preset --</option>
                </select>
                <button type="button" onclick="previewSequencerPreset('chaos', document.getElementById('editChaosPresetSelect').value)" style="padding: 8px 12px; background: #F06292; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Voir les dÃ©tails">
                  ğŸ‘ï¸
                </button>
              </div>
              <button type="button" onclick="loadPresetIntoSequencerModal('chaos')" style="width: 100%; padding: 8px; background: #E91E63; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                â¬‡ï¸ <span data-i18n="sequencer.loadValues">Charger les valeurs</span>
              </button>
            </div>

            <!-- VA-ET-VIENT FIELDS -->
            <div id="vaetFields">
              <!-- Position & Distance -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.startPosition">Position dÃ©part:</label>
                  <input type="number" name="startPositionMM" id="editStartPos" step="1" min="0" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.distanceMM">Distance (mm):</label>
                  <input type="number" name="distanceMM" id="editDistance" step="1" min="1" class="input-modal">
                </div>
              </div>

              <!-- Speeds -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.speedForward">Vitesse aller (/20):</label>
                  <input type="number" name="speedForward" id="editSpeedFwd" min="0" max="20" step="0.1" value="5.0" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.speedBackward">Vitesse retour (/20):</label>
                  <input type="number" name="speedBackward" id="editSpeedBack" min="0" max="20" step="0.1" value="5.0" class="input-modal">
                </div>
              </div>

              <!-- Zone Effects Section (Full ZoneEffectConfig) -->
              <fieldset style="border: 1px solid #667eea; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                <legend style="color: #667eea; font-weight: 500; padding: 0 8px; font-size: 12px;">ğŸ¯ <span data-i18n="sequencer.zoneEffects">Effets de Zone</span></legend>
                
                <!-- Zone Size + Positions -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" name="zoneEnableStart" id="editZoneEnableStart" style="width: 16px; height: 16px;">
                    <span data-i18n="simple.zoneStart">DÃ©but</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" name="zoneEnableEnd" id="editZoneEnableEnd" style="width: 16px; height: 16px;" checked>
                    <span data-i18n="simple.zoneEnd">Fin</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;" data-i18n-title="simple.zoneMirrorTooltip" title="Les zones DÃ©but/Fin restent liÃ©es Ã  leur position physique quel que soit le sens du mouvement">
                    <input type="checkbox" name="zoneMirrorOnReturn" id="editZoneMirror" style="width: 16px; height: 16px;">
                    <span>&#x1F4CC; <span data-i18n="simple.zoneMirror">Position physique</span></span>
                  </label>
                  <span style="margin-left: 10px; font-size: 13px;">Zone:</span>
                  <input type="number" name="zoneMM" id="editZoneMM" min="10" max="200" step="5" value="50" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="font-size: 13px;">mm</span>
                </div>

                <!-- Speed Effect -->
                <div style="background: #f8f9fa; border-radius: 4px; padding: 8px; margin-bottom: 8px;">
                  <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span style="font-size: 13px; font-weight: 500;">ğŸš€ <span data-i18n="simple.speedEffect">Vitesse:</span></span>
                    <select name="speedEffect" id="editSpeedEffect" style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                      <option value="0" data-i18n="simple.speedEffectNone">Aucun</option>
                      <option value="1" selected data-i18n="simple.speedEffectDecel">DÃ©cÃ©lÃ©ration</option>
                      <option value="2" data-i18n="simple.speedEffectAccel">AccÃ©lÃ©ration</option>
                    </select>
                    <span style="font-size: 13px;" data-i18n="simple.curve">Courbe:</span>
                    <select name="speedCurve" id="editSpeedCurve" style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                      <option value="0" data-i18n="simple.curveLinear">LinÃ©aire</option>
                      <option value="1" selected data-i18n="simple.curveSinusoidal">SinusoÃ¯dal</option>
                      <option value="2" data-i18n="simple.curveTriInv">Triangle Inv.</option>
                      <option value="3" data-i18n="simple.curveSinInv">Sinus Inv.</option>
                    </select>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-top: 6px;">
                    <span style="font-size: 13px;" data-i18n="simple.intensity">IntensitÃ©:</span>
                    <input type="range" name="speedIntensity" id="editSpeedIntensity" min="0" max="100" step="5" value="75" style="flex: 1; max-width: 150px;">
                    <span id="editSpeedIntensityValue" style="font-weight: bold; color: #667eea; font-size: 13px; min-width: 35px;">75%</span>
                  </div>
                </div>

                <!-- Random Turnback -->
                <div style="background: #f0f7ff; border-radius: 4px; padding: 8px; margin-bottom: 8px;">
                  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                      <input type="checkbox" name="randomTurnbackEnabled" id="editRandomTurnback" style="width: 16px; height: 16px;">
                      <span style="font-weight: 500;">ğŸ”„ <span data-i18n="sequencer.randomTurnback">Retour alÃ©atoire</span></span>
                    </label>
                    <span style="font-size: 13px; color: #666;" data-i18n="simple.randomTurnbackChance">Chance:</span>
                    <input type="range" name="turnbackChance" id="editTurnbackChance" min="5" max="100" step="5" value="30" style="width: 80px;">
                    <span id="editTurnbackChanceValue" style="font-weight: bold; font-size: 13px; min-width: 35px;">30%</span>
                  </div>
                </div>

                <!-- End Pause -->
                <div style="background: #fff8e6; border-radius: 4px; padding: 8px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                      <input type="checkbox" name="endPauseEnabled" id="editEndPauseEnabled" style="width: 16px; height: 16px;">
                      <span style="font-weight: 500;">â¸ï¸ <span data-i18n="sequencer.endPause">Pause extrÃ©mitÃ©s</span></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; margin-left: 10px;">
                      <input type="radio" name="editEndPauseMode" value="fixed" id="editEndPauseModeFixed" checked style="width: 14px; height: 14px;">
                      <span data-i18n="common.fixed">Fixe</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px;">
                      <input type="radio" name="editEndPauseMode" value="random" id="editEndPauseModeRandom" style="width: 14px; height: 14px;">
                      <span data-i18n="common.random">AlÃ©atoire</span>
                    </label>
                  </div>
                  <!-- Fixed Duration -->
                  <div id="editEndPauseFixedDiv" style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 13px;" data-i18n="common.duration">DurÃ©e:</span>
                    <input type="number" name="endPauseDurationSec" id="editEndPauseDuration" min="0.1" max="30" step="0.1" value="1.0" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="font-size: 13px;">s</span>
                  </div>
                  <!-- Random Min/Max -->
                  <div id="editEndPauseRandomDiv" style="display: none; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span style="font-size: 13px;">Min:</span>
                    <input type="number" name="endPauseMinSec" id="editEndPauseMin" min="0.1" max="30" step="0.1" value="0.5" style="width: 55px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="font-size: 13px;">s</span>
                    <span style="font-size: 13px; margin-left: 8px;">Max:</span>
                    <input type="number" name="endPauseMaxSec" id="editEndPauseMax" min="0.1" max="30" step="0.1" value="2.0" style="width: 55px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                    <span style="font-size: 13px;">s</span>
                  </div>
                </div>
              </fieldset>

              <!-- Cycle Pause Section (VA-ET-VIENT) -->
              <fieldset style="border: 1px solid #f39c12; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
                <legend style="color: #f39c12; font-weight: 500; padding: 0 8px; font-size: 12px;">â¸ï¸ <span data-i18n="sequencer.cyclePause">Pause entre cycles</span></legend>
                
                <div class="flex-gap-15 mb-8 text-md">
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" name="vaetCyclePauseEnabled" id="editVaetPauseEnabled" style="width: 16px; height: 16px;">
                    <span data-i18n="sequencer.enablePause">Activer pause</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" name="vaetCyclePauseIsRandom" id="editVaetPauseRandom" style="width: 16px; height: 16px;">
                    <span data-i18n="sequencer.randomRange">AlÃ©atoire (range)</span>
                  </label>
                </div>

                <div class="grid-2col-12" style="margin-bottom: 8px; gap: 10px;" id="vaetPauseFixedDiv">
                  <div>
                    <label class="label-inline" data-i18n="sequencer.pauseDuration">DurÃ©e pause (s):</label>
                    <input type="number" name="vaetCyclePauseDurationSec" id="editVaetPauseDuration" min="0" max="60" step="0.1" value="0.0" class="input-modal">
                  </div>
                </div>

                <div class="grid-2col-12" style="margin-bottom: 8px; gap: 10px; display: none;" id="vaetPauseRandomDiv">
                  <div>
                    <label class="label-inline">Min (s):</label>
                    <input type="number" name="vaetCyclePauseMinSec" id="editVaetPauseMin" min="0" max="60" step="0.1" value="0.5" class="input-modal">
                  </div>
                  <div>
                    <label class="label-inline">Max (s):</label>
                    <input type="number" name="vaetCyclePauseMaxSec" id="editVaetPauseMax" min="0" max="60" step="0.1" value="3.0" class="input-modal">
                  </div>
                </div>
              </fieldset>
            </div>
            
            <!-- END VA-ET-VIENT FIELDS -->

            <!-- OSCILLATION FIELDS -->
            <div id="oscFields" class="hidden">
              
              <!-- Center & Amplitude -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscCenter">Centre (mm):</label>
                  <input type="number" name="oscCenterPositionMM" id="editOscCenter" step="1" min="0" value="100" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscAmplitude">Amplitude (mm):</label>
                  <input type="number" name="oscAmplitudeMM" id="editOscAmplitude" step="1" min="1" value="50" class="input-modal">
                </div>
              </div>

              <!-- Waveform & Frequency -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscWaveform">Forme d'onde:</label>
                  <select name="oscWaveform" id="editOscWaveform" class="input-modal">
                    <option value="0" data-i18n="sequencer.oscWaveformSine">ã€°ï¸ SinusoÃ¯dal</option>
                    <option value="1" data-i18n="sequencer.oscWaveformTriangle">ğŸ“ Triangle</option>
                    <option value="2" data-i18n="sequencer.oscWaveformSquare">â¬œ CarrÃ©</option>
                  </select>
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscFrequency">FrÃ©quence (Hz):</label>
                  <input type="number" name="oscFrequencyHz" id="editOscFrequency" step="0.01" min="0.01" max="10" value="0.5" class="input-modal">
                </div>
              </div>

              <!-- Ramping -->
              <div class="flex-gap-12" style="flex-direction: column; font-size: 12px; margin-bottom: 12px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                  <input type="checkbox" name="oscEnableRampIn" id="editOscRampIn" style="width: 16px; height: 16px;">
                  <span data-i18n="sequencer.oscRampIn">Rampe entrÃ©e</span>
                </label>
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                  <input type="checkbox" name="oscEnableRampOut" id="editOscRampOut" style="width: 16px; height: 16px;">
                  <span data-i18n="sequencer.oscRampOut">Rampe sortie</span>
                </label>
              </div>

              <!-- Ramp Durations -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscRampInDur">DurÃ©e rampe IN (ms):</label>
                  <input type="number" name="oscRampInDurationMs" id="editOscRampInDur" min="100" max="10000" step="100" value="1000" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.oscRampOutDur">DurÃ©e rampe OUT (ms):</label>
                  <input type="number" name="oscRampOutDurationMs" id="editOscRampOutDur" min="100" max="10000" step="100" value="1000" class="input-modal">
                </div>
              </div>

              <!-- Cycle Pause Section (OSCILLATION) -->
              <fieldset style="border: 1px solid #f39c12; border-radius: 6px; padding: 10px; margin-top: 10px;">
                <legend style="color: #f39c12; font-weight: 500; padding: 0 8px; font-size: 12px;">â¸ï¸ <span data-i18n="sequencer.cyclePause">Pause entre cycles</span></legend>
                
                <div class="flex-gap-15 mb-8 text-md">
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" name="oscCyclePauseEnabled" id="editOscPauseEnabled" style="width: 16px; height: 16px;">
                    <span data-i18n="sequencer.enablePause">Activer pause</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                    <input type="checkbox" name="oscCyclePauseIsRandom" id="editOscPauseRandom" style="width: 16px; height: 16px;">
                    <span data-i18n="sequencer.randomRange">AlÃ©atoire (range)</span>
                  </label>
                </div>

                <div class="grid-2col-12" style="margin-bottom: 8px; gap: 10px;" id="oscPauseFixedDiv">
                  <div>
                    <label class="label-inline" data-i18n="sequencer.pauseDuration">DurÃ©e pause (s):</label>
                    <input type="number" name="oscCyclePauseDurationSec" id="editOscPauseDuration" min="0" max="60" step="0.1" value="0.0" class="input-modal">
                  </div>
                </div>

                <div class="grid-2col-12" style="margin-bottom: 8px; gap: 10px; display: none;" id="oscPauseRandomDiv">
                  <div>
                    <label class="label-inline">Min (s):</label>
                    <input type="number" name="oscCyclePauseMinSec" id="editOscPauseMin" min="0" max="60" step="0.1" value="0.5" class="input-modal">
                  </div>
                  <div>
                    <label class="label-inline">Max (s):</label>
                    <input type="number" name="oscCyclePauseMaxSec" id="editOscPauseMax" min="0" max="60" step="0.1" value="3.0" class="input-modal">
                  </div>
                </div>
              </fieldset>

            </div>
            <!-- END OSCILLATION FIELDS -->

            <!-- CHAOS FIELDS -->
            <div id="chaosFields" class="hidden">
              
              <!-- Center & Amplitude -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosCenter">Centre (mm):</label>
                  <input type="number" name="chaosCenterPositionMM" id="editChaosCenter" step="1" min="0" value="110" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosAmplitude">Amplitude (mm):</label>
                  <input type="number" name="chaosAmplitudeMM" id="editChaosAmplitude" step="1" min="1" value="50" class="input-modal">
                </div>
              </div>

              <!-- Speed & Craziness -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosMaxSpeed">Vitesse max (/20):</label>
                  <input type="number" name="chaosMaxSpeedLevel" id="editChaosSpeed" min="1" max="20" step="0.5" value="10" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosCraziness">ğŸ² Folie (%):</label>
                  <input type="number" name="chaosCrazinessPercent" id="editChaosCraziness" min="0" max="100" step="5" value="50" class="input-modal">
                </div>
              </div>

              <!-- Duration & Seed -->
              <div class="grid-2col-12">
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosDuration">â±ï¸ DurÃ©e (s) 5-600:</label>
                  <input type="number" name="chaosDurationSeconds" id="editChaosDuration" min="5" max="600" step="5" value="30" class="input-modal">
                </div>
                <div>
                  <label class="label-inline" data-i18n="sequencer.chaosSeed">ğŸŒ± Seed (0=alÃ©a):</label>
                  <input type="number" name="chaosSeed" id="editChaosSeed" min="0" max="9999999" step="1" value="0" class="input-modal">
                </div>
              </div>

              <!-- Patterns Selection -->
              <div class="mb-10">
                <label class="label-inline">ğŸ­ <span data-i18n="sequencer.chaosPatterns">Patterns actifs:</span></label>
                <div class="grid-4col-patterns">
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern0" checked style="width: 14px; height: 14px;">
                    <span>âš¡ ZigZag</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern1" checked style="width: 14px; height: 14px;">
                    <span>ğŸ“Š Sweep</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern2" checked style="width: 14px; height: 14px;">
                    <span>ğŸ’¥ Pulse</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern3" checked style="width: 14px; height: 14px;">
                    <span>ğŸŒŠ Drift</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern4" checked style="width: 14px; height: 14px;">
                    <span>ğŸ’¨ Burst</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern5" checked style="width: 14px; height: 14px;">
                    <span>ã€°ï¸ Wave</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern6" checked style="width: 14px; height: 14px;">
                    <span>âš–ï¸ Pendul</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern7" checked style="width: 14px; height: 14px;">
                    <span>ğŸŒ€ Spiral</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern8" checked style="width: 14px; height: 14px;">
                    <span>ğŸ˜Œ Breathing</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern9" checked style="width: 14px; height: 14px;">
                    <span>ğŸ”¨ BruteForce</span>
                  </label>
                  <label class="checkbox-label-sm">
                    <input type="checkbox" name="chaosPattern10" checked style="width: 14px; height: 14px;">
                    <span>ğŸ”“ Liberator</span>
                  </label>
                </div>
              </div>

            </div>
            <!-- END CHAOS FIELDS -->

            <!-- COMMON FIELDS (Cycles & Pause) -->
            <!-- Cycles & Pause -->
            <div class="grid-2col-12 mb-12">
              <div id="cyclesFieldDiv">
                <label class="label-inline" data-i18n="sequencer.cyclesRange">Cycles (1-1000):</label>
                <input type="number" name="cycleCount" id="editCycles" min="1" max="1000" step="1" value="1" class="input-modal">
              </div>
              <div id="pauseFieldDiv">
                <label class="label-inline" data-i18n="sequencer.pauseAfter">â±ï¸ Pause (s) 0-60:</label>
                <input type="number" name="pauseAfterSec" id="editPause" min="0" max="60" step="0.1" value="0" class="input-modal">
              </div>
            </div>

            <!-- Validation Error Display -->
            <div id="editValidationErrors" style="display: none; margin-bottom: 10px; padding: 10px; background: rgba(245,101,101,0.08); border-left: 4px solid #f56565; border-radius: 8px; font-size: 12px;">
              <div style="font-weight: bold; color: #d32f2f; margin-bottom: 5px;">âŒ <span data-i18n="sequencer.validationErrors">Erreurs de validation :</span></div>
              <ul id="editValidationErrorsList" style="margin: 0; padding-left: 20px; color: #c62828; font-size: 13px;">
              </ul>
            </div>

            <!-- Action Buttons -->
            <div class="flex-gap-10 flex-end">
              <button type="submit" id="btnSaveEdit" class="button btn-success" style="padding: 10px 24px; font-size: 14px;">
                ğŸ’¾ <span data-i18n="sequencer.saveBtn">Enregistrer</span>
              </button>
              <button type="button" id="btnCancelEdit" class="button btn-secondary" style="padding: 10px 24px; font-size: 14px; background: #999;">
                âŒ <span data-i18n="sequencer.cancelBtn">Annuler</span>
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
    <!-- END EDIT MODAL -->

  </div>

  <!-- Script Loader: downloads 2 at a time, executes in order, retries on failure.
       ESP32 web server handles ~4-6 concurrent connections;
       2 parallel downloads balances speed vs. reliability. -->
  <script>
  (function() {
    var scripts = [
      '/js/lib/chart.umd.min.js',
      '/js/lib/Sortable.min.js',
      '/js/ui/milestones.js',
      '/js/ui/speedMilestones.js',
      '/js/core/app.js',
      '/js/core/i18n.js',
      '/js/utils/utils.js',
      '/js/core/DOMManager.js',
      '/js/core/websocket.js',
      '/js/ui/StatsController.js',
      '/js/ui/ToolsController.js',
      '/js/ui/UIController.js',
      '/js/utils/PlaylistUtils.js',
      '/js/utils/SimpleUtils.js',
      '/js/utils/SequenceUtils.js',
      '/js/controllers/PlaylistController.js',
      '/js/controllers/SimpleController.js',
      '/js/controllers/PursuitController.js',
      '/js/controllers/OscillationController.js',
      '/js/controllers/ChaosController.js',
      '/js/controllers/SequenceController.js',
      '/js/main.js'
    ];
    var CONCURRENT = 2;
    var MAX_RETRIES = 3;
    var RETRY_DELAY = 800;
    var CACHE_BUST = '_v=' + Date.now();
    var overlay = document.getElementById('scriptLoadOverlay');
    var bar = document.getElementById('scriptLoadBar');
    var text = document.getElementById('scriptLoadText');
    var total = scripts.length;
    var loaded = 0;        // count of fully loaded+executed scripts
    var fetched = {};      // idx -> blob URL (downloaded but waiting for execution turn)
    var fetchNext = 0;     // next index to start fetching

    function updateUI(idx, name, retry) {
      var pct = Math.round((loaded / total) * 100);
      if (bar) bar.style.width = pct + '%';
      var label = name ? name.split('/').pop() : '';
      if (text) text.textContent = label + (retry > 0 ? ' (retry ' + retry + ')' : '') + ' (' + loaded + '/' + total + ')';
    }

    function done() {
      if (overlay) overlay.style.display = 'none';
      // main.js (last script) self-initializes via async IIFE â€” no event needed
    }

    // Execute scripts in strict order: loaded index must match next expected
    function tryExecuteNext() {
      if (loaded >= total) { done(); return; }
      if (!(loaded in fetched)) return; // not downloaded yet
      var blobUrl = fetched[loaded];
      delete fetched[loaded];
      var s = document.createElement('script');
      s.src = blobUrl;
      s.onload = function() {
        URL.revokeObjectURL(blobUrl);
        loaded++;
        updateUI(loaded, scripts[loaded - 1], 0);
        tryExecuteNext();  // execute next if already fetched
        pump();            // start fetching more
      };
      s.onerror = function() {
        // blob exec error â€” should not happen, fallback reload
        URL.revokeObjectURL(blobUrl);
        console.error('[Loader] Exec error: ' + scripts[loaded]);
        if (text) text.textContent = 'Error â€” tap to reload';
        if (overlay) overlay.onclick = function() { location.reload(); };
      };
      document.body.appendChild(s);
    }

    function fetchScript(idx, attempt) {
      var src = scripts[idx];
      updateUI(idx, src, attempt);
      var xhr = new XMLHttpRequest();
      xhr.open('GET', src + '?' + CACHE_BUST + (attempt > 0 ? '&r=' + attempt : ''), true);
      xhr.responseType = 'blob';
      xhr.onload = function() {
        if (xhr.status === 200) {
          fetched[idx] = URL.createObjectURL(xhr.response);
          tryExecuteNext();
        } else {
          retryOrFail(idx, attempt, src);
        }
      };
      xhr.onerror = function() { retryOrFail(idx, attempt, src); };
      xhr.send();
    }

    function retryOrFail(idx, attempt, src) {
      if (attempt < MAX_RETRIES) {
        setTimeout(function() { fetchScript(idx, attempt + 1); }, RETRY_DELAY);
      } else {
        console.error('[Loader] Failed after ' + MAX_RETRIES + ' retries: ' + src);
        if (text) text.textContent = 'Error loading ' + src.split('/').pop() + ' â€” tap to reload';
        if (overlay) overlay.onclick = function() { location.reload(); };
      }
    }

    // Start up to CONCURRENT fetches
    function pump() {
      while (fetchNext < total && fetchNext - loaded < CONCURRENT) {
        fetchScript(fetchNext, 0);
        fetchNext++;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { pump(); });
    } else {
      pump();
    }
  })();
  </script>

</body>
</html>