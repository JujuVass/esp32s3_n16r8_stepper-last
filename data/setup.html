<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration WiFi - ESP32 Stepper</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 420px;
      width: 100%;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }
    
    .content {
      padding: 24px;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .section-title h2 {
      font-size: 1rem;
      color: #333;
    }
    
    .btn-scan {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    
    .btn-scan:hover {
      background: #1976D2;
    }
    
    .btn-scan:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-scan.scanning {
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .networks-list {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      max-height: 280px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .network-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .network-item:last-child {
      border-bottom: none;
    }
    
    .network-item:hover {
      background: #f5f5f5;
    }
    
    .network-item.selected {
      background: #e3f2fd;
      border-left: 3px solid #2196F3;
    }
    
    .signal-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-right: 12px;
      height: 16px;
    }
    
    .signal-bar {
      width: 4px;
      background: #ccc;
      border-radius: 1px;
    }
    
    .signal-bar.active {
      background: #4CAF50;
    }
    
    .signal-bar:nth-child(1) { height: 4px; }
    .signal-bar:nth-child(2) { height: 8px; }
    .signal-bar:nth-child(3) { height: 12px; }
    .signal-bar:nth-child(4) { height: 16px; }
    
    .network-info {
      flex: 1;
    }
    
    .network-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
    }
    
    .network-details {
      font-size: 0.75rem;
      color: #888;
    }
    
    .network-lock {
      font-size: 1.1rem;
      margin-left: 8px;
    }
    
    .password-section {
      display: none;
      margin-bottom: 20px;
    }
    
    .password-section.visible {
      display: block;
    }
    
    .selected-network {
      background: #e8f5e9;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .selected-network-name {
      font-weight: 500;
      color: #2e7d32;
    }
    
    .input-group {
      position: relative;
    }
    
    .input-group input {
      width: 100%;
      padding: 14px 48px 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #2196F3;
    }
    
    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.6;
    }
    
    .toggle-password:hover {
      opacity: 1;
    }
    
    .btn-connect {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-connect:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .status-message {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    
    .status-message.visible {
      display: block;
    }
    
    .status-message.success {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .status-message.error {
      background: #ffebee;
      color: #c62828;
    }
    
    .status-message.info {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .footer {
      background: #f5f5f5;
      padding: 16px 24px;
      text-align: center;
    }
    
    .footer p {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 8px;
    }
    
    .footer .ip {
      font-family: monospace;
      background: #fff;
      padding: 4px 12px;
      border-radius: 4px;
      color: #333;
    }
    
    .current-config {
      background: #fff3e0;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .current-config-info {
      font-size: 0.9rem;
    }
    
    .current-config-ssid {
      font-weight: 600;
      color: #e65100;
    }
    
    .btn-forget {
      background: #ff5722;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-forget:hover {
      background: #e64a19;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    
    .empty-state .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .back-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #2196F3;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß Configuration WiFi</h1>
      <p>ESP32 Stepper Controller</p>
    </div>
    
    <div class="content">
      <!-- Current configuration (if exists) -->
      <div id="currentConfig" class="current-config" style="display: none;">
        <div class="current-config-info">
          üì∂ Connect√© √†: <span id="currentSsid" class="current-config-ssid"></span>
        </div>
        <button class="btn-forget" onclick="forgetWifi()">üóëÔ∏è Oublier</button>
      </div>
      
      <!-- Scan section -->
      <div class="section-title">
        <h2>üì∂ R√©seaux WiFi disponibles</h2>
        <button id="btnScan" class="btn-scan" onclick="scanNetworks()">
          <span id="scanIcon">üîÑ</span> Scanner
        </button>
      </div>
      
      <!-- Networks list -->
      <div id="networksList" class="networks-list">
        <div class="empty-state">
          <div class="icon">üì°</div>
          <p>Cliquez sur "Scanner" pour rechercher les r√©seaux WiFi</p>
        </div>
      </div>
      
      <!-- Password section -->
      <div id="passwordSection" class="password-section">
        <div class="selected-network">
          <span>‚úÖ R√©seau s√©lectionn√©:</span>
          <span id="selectedNetworkName" class="selected-network-name"></span>
        </div>
        
        <div class="input-group">
          <input type="password" id="passwordInput" placeholder="Mot de passe WiFi" autocomplete="off">
          <button class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</button>
        </div>
      </div>
      
      <!-- Connect button -->
      <button id="btnConnect" class="btn-connect" onclick="connectWifi()" disabled>
        üì° Se connecter
      </button>
      
      <!-- Status message -->
      <div id="statusMessage" class="status-message"></div>

      <!-- Back link (only if already configured) -->
      <a id="backLink" href="/" class="back-link" style="display: none;">‚Üê Retour √† l'interface principale</a>
    </div>
    
    <div class="footer">
      <p>üí° Connectez-vous au r√©seau WiFi de l'ESP32</p>
      <p>puis acc√©dez √† <span class="ip">http://192.168.4.1</span></p>
    </div>
  </div>

  <script>
    let selectedNetwork = null;
    let isSecure = true;

    // Check current config on load
    window.onload = function() {
      checkCurrentConfig();
      scanNetworks();
    };

    async function checkCurrentConfig() {
      try {
        const response = await fetch('/api/wifi/config');
        const data = await response.json();
        
        if (data.configured && data.ssid) {
          document.getElementById('currentConfig').style.display = 'flex';
          document.getElementById('currentSsid').textContent = data.ssid;
          document.getElementById('backLink').style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking config:', error);
      }
    }

    async function scanNetworks() {
      const btn = document.getElementById('btnScan');
      const icon = document.getElementById('scanIcon');
      const list = document.getElementById('networksList');
      
      btn.disabled = true;
      btn.classList.add('scanning');
      icon.innerHTML = '<span class="spinner"></span>';
      
      list.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><p>Recherche en cours...</p></div>';
      
      try {
        const response = await fetch('/api/wifi/scan');
        const data = await response.json();
        
        if (data.networks && data.networks.length > 0) {
          list.innerHTML = data.networks.map(net => createNetworkItem(net)).join('');
        } else {
          list.innerHTML = '<div class="empty-state"><div class="icon">üòï</div><p>Aucun r√©seau trouv√©</p></div>';
        }
      } catch (error) {
        list.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><p>Erreur de scan</p></div>';
        console.error('Scan error:', error);
      }
      
      btn.disabled = false;
      btn.classList.remove('scanning');
      icon.textContent = 'üîÑ';
    }

    function createNetworkItem(network) {
      const signalBars = getSignalBars(network.rssi);
      const lockIcon = network.secure ? 'üîí' : 'üîì';
      
      return `
        <div class="network-item" onclick="selectNetwork('${escapeHtml(network.ssid)}', ${network.secure})">
          <div class="signal-bars">
            ${signalBars}
          </div>
          <div class="network-info">
            <div class="network-name">${escapeHtml(network.ssid)}</div>
            <div class="network-details">${network.encryption} ‚Ä¢ Ch.${network.channel} ‚Ä¢ ${network.rssi} dBm</div>
          </div>
          <span class="network-lock">${lockIcon}</span>
        </div>
      `;
    }

    function getSignalBars(rssi) {
      let bars = 1;
      if (rssi >= -50) bars = 4;
      else if (rssi >= -60) bars = 3;
      else if (rssi >= -70) bars = 2;
      
      let html = '';
      for (let i = 1; i <= 4; i++) {
        html += `<div class="signal-bar ${i <= bars ? 'active' : ''}"></div>`;
      }
      return html;
    }

    function selectNetwork(ssid, secure) {
      selectedNetwork = ssid;
      isSecure = secure;
      
      // Update UI
      document.querySelectorAll('.network-item').forEach(item => {
        item.classList.remove('selected');
        if (item.querySelector('.network-name').textContent === ssid) {
          item.classList.add('selected');
        }
      });
      
      document.getElementById('selectedNetworkName').textContent = ssid;
      
      const passwordSection = document.getElementById('passwordSection');
      const passwordInput = document.getElementById('passwordInput');
      const btnConnect = document.getElementById('btnConnect');
      
      if (secure) {
        passwordSection.classList.add('visible');
        passwordInput.focus();
        btnConnect.disabled = true;
        passwordInput.oninput = () => {
          btnConnect.disabled = passwordInput.value.length < 8;
        };
      } else {
        passwordSection.classList.remove('visible');
        btnConnect.disabled = false;
      }
    }

    function togglePassword() {
      const input = document.getElementById('passwordInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function connectWifi() {
      if (!selectedNetwork) return;
      
      const btn = document.getElementById('btnConnect');
      const password = document.getElementById('passwordInput').value;
      const statusEl = document.getElementById('statusMessage');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Connexion...';
      
      showStatus('info', 'üîå Connexion en cours...');
      
      try {
        const response = await fetch('/api/wifi/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ssid: selectedNetwork,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showStatus('success', '‚úÖ ' + data.message + ' IP: ' + data.ip);
          btn.innerHTML = '‚úÖ Connect√©!';
          
          // Redirect after 3 seconds
          setTimeout(() => {
            showStatus('info', 'üîÑ Red√©marrage de l\'ESP32...');
          }, 1000);
        } else {
          showStatus('error', '‚ùå ' + (data.error || 'Connexion √©chou√©e'));
          btn.disabled = false;
          btn.innerHTML = 'üì° Se connecter';
        }
      } catch (error) {
        showStatus('error', '‚ùå Erreur de connexion');
        btn.disabled = false;
        btn.innerHTML = 'üì° Se connecter';
        console.error('Connect error:', error);
      }
    }

    async function forgetWifi() {
      if (!confirm('Oublier cette configuration WiFi ?\n\nL\'ESP32 red√©marrera en mode configuration.')) {
        return;
      }
      
      try {
        const response = await fetch('/api/wifi/forget', { method: 'POST' });
        const data = await response.json();
        
        showStatus('info', 'üîÑ ' + data.message);
      } catch (error) {
        showStatus('error', '‚ùå Erreur');
        console.error('Forget error:', error);
      }
    }

    function showStatus(type, message) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.className = 'status-message visible ' + type;
      statusEl.textContent = message;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
