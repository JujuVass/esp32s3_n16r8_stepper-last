<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration WiFi - ESP32 Stepper</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 420px;
      width: 100%;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 24px;
      text-align: center;
    }
    
    .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 0.9rem; }
    
    .content { padding: 24px; }
    
    /* Mode indicator */
    .mode-indicator {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      font-size: 0.9rem;
    }
    .mode-indicator.ap-mode {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4CAF50;
    }
    .mode-indicator.sta-mode {
      background: #fff3e0;
      color: #e65100;
      border: 2px solid #ff9800;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .section-title h2 { font-size: 1rem; color: #333; }
    
    .btn-scan {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    .btn-scan:hover { background: #1976D2; }
    .btn-scan:disabled { background: #ccc; cursor: not-allowed; }
    .btn-scan.scanning { animation: pulse 1s infinite; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    
    .networks-list {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      max-height: 280px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .network-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .network-item:last-child { border-bottom: none; }
    .network-item:hover { background: #f5f5f5; }
    .network-item.selected { background: #e3f2fd; border-left: 3px solid #2196F3; }
    
    .signal-bars {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      margin-right: 12px;
      height: 16px;
    }
    .signal-bar {
      width: 4px;
      background: #ccc;
      border-radius: 1px;
    }
    .signal-bar.active { background: #4CAF50; }
    .signal-bar:nth-child(1) { height: 4px; }
    .signal-bar:nth-child(2) { height: 8px; }
    .signal-bar:nth-child(3) { height: 12px; }
    .signal-bar:nth-child(4) { height: 16px; }
    
    .network-info { flex: 1; }
    .network-name { font-weight: 500; color: #333; margin-bottom: 2px; }
    .network-details { font-size: 0.75rem; color: #888; }
    .network-lock { font-size: 1.1rem; margin-left: 8px; }
    
    .password-section { display: none; margin-bottom: 20px; }
    .password-section.visible { display: block; }
    
    .selected-network {
      background: #e8f5e9;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .selected-network-name { font-weight: 500; color: #2e7d32; }
    
    .input-group { position: relative; }
    .input-group input {
      width: 100%;
      padding: 14px 48px 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .input-group input:focus { outline: none; border-color: #2196F3; }
    
    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      opacity: 0.6;
    }
    .toggle-password:hover { opacity: 1; }
    
    .btn-connect, .btn-reboot {
      width: 100%;
      padding: 16px;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-connect {
      background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
    }
    .btn-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }
    .btn-connect:disabled, .btn-reboot:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-reboot {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      margin-top: 12px;
    }
    .btn-reboot:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    .status-message {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      text-align: center;
      display: none;
    }
    .status-message.visible { display: block; }
    .status-message.success { background: #e8f5e9; color: #2e7d32; }
    .status-message.error { background: #ffebee; color: #c62828; }
    .status-message.info { background: #e3f2fd; color: #1565c0; }
    .status-message.warning { background: #fff3e0; color: #e65100; }
    
    .footer {
      background: #f5f5f5;
      padding: 16px 24px;
      text-align: center;
    }
    .footer p { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
    .footer .ip {
      font-family: monospace;
      background: #fff;
      padding: 4px 12px;
      border-radius: 4px;
      color: #333;
    }
    
    .current-config {
      background: #fff3e0;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .current-config-info { font-size: 0.9rem; }
    .current-config-ssid { font-weight: 600; color: #e65100; }
    
    .btn-forget {
      background: #ff5722;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .btn-forget:hover { background: #e64a19; }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #888;
    }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .back-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #2196F3;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    
    /* Success screen */
    .success-screen {
      display: none;
      text-align: center;
      padding: 20px 0;
    }
    .success-screen.visible { display: block; }
    .success-screen .icon { font-size: 4rem; margin-bottom: 16px; }
    .success-screen h2 { color: #2e7d32; margin-bottom: 12px; }
    .success-screen .ssid { 
      font-weight: 600; 
      color: #1976D2;
      font-size: 1.2rem;
      margin-bottom: 16px;
    }
    .success-screen .instructions {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 10px;
      margin: 16px 0;
      text-align: left;
    }
    .success-screen .instructions li {
      margin: 8px 0;
      color: #555;
    }
    .success-screen .hostname {
      font-family: monospace;
      background: #e3f2fd;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 1.1rem;
      color: #1565c0;
      display: inline-block;
      margin: 12px 0;
    }
    .countdown {
      font-size: 2rem;
      font-weight: bold;
      color: #2196F3;
      margin: 16px 0;
    }
    
    /* Blocked screen (STA mode) */
    .blocked-screen {
      display: none;
      text-align: center;
      padding: 20px 0;
    }
    .blocked-screen.visible { display: block; }
    .blocked-screen .icon { font-size: 4rem; margin-bottom: 16px; }
    .blocked-screen h2 { color: #e65100; margin-bottom: 12px; }
    .blocked-screen p { color: #666; margin-bottom: 16px; line-height: 1.5; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß Configuration WiFi</h1>
      <p>ESP32 Stepper Controller</p>
    </div>
    
    <div class="content">
      <!-- Mode indicator -->
      <div id="modeIndicator" class="mode-indicator ap-mode">
        ‚úÖ Mode Configuration (AP) - Modifications autoris√©es
      </div>
      
      <!-- Blocked screen when in STA mode -->
      <div id="blockedScreen" class="blocked-screen">
        <div class="icon">üîí</div>
        <h2>Configuration bloqu√©e</h2>
        <p>La modification du WiFi n'est pas possible lorsque l'ESP32 est d√©j√† connect√© √† un r√©seau.</p>
        <p>Pour changer de r√©seau WiFi :</p>
        <ol style="text-align: left; margin: 16px 0; padding-left: 24px; color: #555;">
          <li>Cliquez sur "Oublier ce r√©seau" ci-dessous</li>
          <li>L'ESP32 red√©marrera en mode AP</li>
          <li>Connectez-vous au r√©seau <strong>esp32-stepper-AP</strong></li>
          <li>Acc√©dez √† <strong>http://192.168.4.1</strong></li>
        </ol>
        <button id="btnForgetBlocked" class="btn-forget" style="padding: 12px 24px; font-size: 1rem;" onclick="forgetWifi()">
          üóëÔ∏è Oublier ce r√©seau
        </button>
        <a href="/" class="back-link">‚Üê Retour √† l'interface principale</a>
      </div>
      
      <!-- Main config screen -->
      <div id="configScreen">
        <!-- Current configuration (if exists) -->
        <div id="currentConfig" class="current-config" style="display: none;">
          <div class="current-config-info">
            üì∂ Config actuelle: <span id="currentSsid" class="current-config-ssid"></span>
          </div>
          <button class="btn-forget" onclick="forgetWifi()">üóëÔ∏è Oublier</button>
        </div>
        
        <!-- Scan section -->
        <div class="section-title">
          <h2>üì∂ R√©seaux WiFi</h2>
          <button id="btnScan" class="btn-scan" onclick="scanNetworks()">
            <span id="scanIcon">üîÑ</span> Scanner
          </button>
        </div>
        
        <!-- Networks list -->
        <div id="networksList" class="networks-list">
          <div class="empty-state">
            <div class="icon">üì°</div>
            <p>Cliquez sur "Scanner" pour rechercher les r√©seaux WiFi</p>
          </div>
        </div>
        
        <!-- Password section -->
        <div id="passwordSection" class="password-section">
          <div class="selected-network">
            <span>‚úÖ R√©seau:</span>
            <span id="selectedNetworkName" class="selected-network-name"></span>
          </div>
          
          <div class="input-group">
            <input type="password" id="passwordInput" placeholder="Mot de passe WiFi" autocomplete="off">
            <button class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</button>
          </div>
        </div>
        
        <!-- Connect button -->
        <button id="btnConnect" class="btn-connect" onclick="connectWifi()" disabled>
          üì° Se connecter
        </button>
        
        <!-- Status message -->
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Back link -->
        <a id="backLink" href="/" class="back-link" style="display: none;">‚Üê Retour √† l'interface</a>
      </div>
      
      <!-- Success screen -->
      <div id="successScreen" class="success-screen">
        <div class="icon">‚úÖ</div>
        <h2>WiFi configur√© avec succ√®s!</h2>
        <div class="ssid" id="successSsid"></div>
        
        <div class="instructions">
          <strong>Prochaines √©tapes :</strong>
          <ol>
            <li>Cliquez sur "Red√©marrer" ci-dessous</li>
            <li>Reconnectez-vous √† votre WiFi <span id="homeWifiName"></span></li>
            <li>Acc√©dez √† l'interface via :</li>
          </ol>
        </div>
        
        <div class="hostname" id="dnsHostname">esp32-stepper.local</div>
        <p style="font-size: 0.85rem; color: #888; margin-top: 8px;">ou via l'IP qui sera affich√©e dans les logs</p>
        
        <button id="btnReboot" class="btn-reboot" onclick="rebootEsp()">
          üîÑ Red√©marrer l'ESP32
        </button>
        
        <div id="rebootCountdown" style="display: none; margin-top: 20px;">
          <p>Red√©marrage en cours...</p>
          <div class="countdown" id="countdownValue">10</div>
          <p style="font-size: 0.9rem; color: #666;">Reconnectez-vous √† votre WiFi puis acc√©dez √† l'interface</p>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>üí° Mode AP: Connectez-vous √† <strong>esp32-stepper-AP</strong></p>
      <p>Adresse: <span class="ip">http://192.168.4.1</span></p>
    </div>
  </div>

  <script>
    let selectedNetwork = null;
    let isSecure = true;
    let isStaConnected = false;

    // Check mode on load
    window.onload = async function() {
      await checkMode();
      if (!isStaConnected) {
        await checkCurrentConfig();
        scanNetworks();
      }
    };

    async function checkMode() {
      try {
        const response = await fetch('/api/wifi/config');
        const data = await response.json();
        
        isStaConnected = data.connected;
        
        const modeIndicator = document.getElementById('modeIndicator');
        const blockedScreen = document.getElementById('blockedScreen');
        const configScreen = document.getElementById('configScreen');
        
        if (isStaConnected) {
          // STA mode - block configuration
          modeIndicator.className = 'mode-indicator sta-mode';
          modeIndicator.innerHTML = '‚ö†Ô∏è Mode Connect√© (STA) - Configuration bloqu√©e';
          blockedScreen.classList.add('visible');
          configScreen.classList.add('hidden');
        } else {
          // AP mode - allow configuration
          modeIndicator.className = 'mode-indicator ap-mode';
          modeIndicator.innerHTML = '‚úÖ Mode Configuration (AP) - Modifications autoris√©es';
          blockedScreen.classList.remove('visible');
          configScreen.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error checking mode:', error);
      }
    }

    async function checkCurrentConfig() {
      try {
        const response = await fetch('/api/wifi/config');
        const data = await response.json();
        
        if (data.configured && data.ssid) {
          document.getElementById('currentConfig').style.display = 'flex';
          document.getElementById('currentSsid').textContent = data.ssid;
          document.getElementById('backLink').style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking config:', error);
      }
    }

    async function scanNetworks() {
      const btn = document.getElementById('btnScan');
      const icon = document.getElementById('scanIcon');
      const list = document.getElementById('networksList');
      
      btn.disabled = true;
      btn.classList.add('scanning');
      icon.innerHTML = '<span class="spinner"></span>';
      
      list.innerHTML = '<div class="empty-state"><div class="icon">üì°</div><p>Recherche en cours...</p></div>';
      
      try {
        const response = await fetch('/api/wifi/scan');
        const data = await response.json();
        
        if (data.networks && data.networks.length > 0) {
          list.innerHTML = data.networks.map(net => createNetworkItem(net)).join('');
        } else {
          list.innerHTML = '<div class="empty-state"><div class="icon">üòï</div><p>Aucun r√©seau trouv√©</p></div>';
        }
      } catch (error) {
        list.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><p>Erreur de scan</p></div>';
        console.error('Scan error:', error);
      }
      
      btn.disabled = false;
      btn.classList.remove('scanning');
      icon.textContent = 'üîÑ';
    }

    function createNetworkItem(network) {
      const signalBars = getSignalBars(network.rssi);
      const lockIcon = network.secure ? 'üîí' : 'üîì';
      
      return `
        <div class="network-item" onclick="selectNetwork('${escapeHtml(network.ssid)}', ${network.secure})">
          <div class="signal-bars">${signalBars}</div>
          <div class="network-info">
            <div class="network-name">${escapeHtml(network.ssid)}</div>
            <div class="network-details">${network.encryption} ‚Ä¢ Ch.${network.channel} ‚Ä¢ ${network.rssi} dBm</div>
          </div>
          <span class="network-lock">${lockIcon}</span>
        </div>
      `;
    }

    function getSignalBars(rssi) {
      let bars = 1;
      if (rssi >= -50) bars = 4;
      else if (rssi >= -60) bars = 3;
      else if (rssi >= -70) bars = 2;
      
      let html = '';
      for (let i = 1; i <= 4; i++) {
        html += `<div class="signal-bar ${i <= bars ? 'active' : ''}"></div>`;
      }
      return html;
    }

    function selectNetwork(ssid, secure) {
      selectedNetwork = ssid;
      isSecure = secure;
      
      document.querySelectorAll('.network-item').forEach(item => {
        item.classList.remove('selected');
        if (item.querySelector('.network-name').textContent === ssid) {
          item.classList.add('selected');
        }
      });
      
      document.getElementById('selectedNetworkName').textContent = ssid;
      
      const passwordSection = document.getElementById('passwordSection');
      const passwordInput = document.getElementById('passwordInput');
      const btnConnect = document.getElementById('btnConnect');
      
      if (secure) {
        passwordSection.classList.add('visible');
        passwordInput.value = '';
        passwordInput.focus();
        btnConnect.disabled = true;
        passwordInput.oninput = () => {
          btnConnect.disabled = passwordInput.value.length < 8;
        };
      } else {
        passwordSection.classList.remove('visible');
        btnConnect.disabled = false;
      }
    }

    function togglePassword() {
      const input = document.getElementById('passwordInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function connectWifi() {
      if (!selectedNetwork) return;
      
      const btn = document.getElementById('btnConnect');
      const password = document.getElementById('passwordInput').value;
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Test de connexion...';
      
      showStatus('info', 'üîå Test de connexion en cours (15s max)...');
      
      try {
        const response = await fetch('/api/wifi/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ssid: selectedNetwork, password: password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show success screen
          document.getElementById('configScreen').classList.add('hidden');
          document.getElementById('modeIndicator').classList.add('hidden');
          
          document.getElementById('successScreen').classList.add('visible');
          document.getElementById('successSsid').textContent = data.ssid;
          document.getElementById('homeWifiName').textContent = data.ssid;
          document.getElementById('dnsHostname').textContent = data.hostname || 'esp32-stepper.local';
          
        } else {
          showStatus('error', '‚ùå ' + (data.error || 'Connexion √©chou√©e'));
          if (data.hint) {
            showStatus('warning', 'üí° ' + data.hint);
          }
          btn.disabled = false;
          btn.innerHTML = 'üì° Se connecter';
        }
      } catch (error) {
        showStatus('error', '‚ùå Erreur de connexion');
        btn.disabled = false;
        btn.innerHTML = 'üì° Se connecter';
        console.error('Connect error:', error);
      }
    }

    async function rebootEsp() {
      const btn = document.getElementById('btnReboot');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Red√©marrage...';
      
      document.getElementById('rebootCountdown').style.display = 'block';
      
      try {
        await fetch('/api/wifi/reboot', { method: 'POST' });
      } catch (e) {
        // Expected - connection will be lost
      }
      
      // Countdown
      let countdown = 10;
      const countdownEl = document.getElementById('countdownValue');
      const interval = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(interval);
          countdownEl.textContent = 'üîÑ';
        }
      }, 1000);
    }

    async function forgetWifi() {
      if (!confirm('Oublier cette configuration WiFi ?\n\nL\'ESP32 red√©marrera en mode configuration (AP).')) {
        return;
      }
      
      try {
        showStatus('info', 'üóëÔ∏è Suppression de la configuration...');
        const response = await fetch('/api/wifi/forget', { method: 'POST' });
        const data = await response.json();
        
        showStatus('info', 'üîÑ Red√©marrage en cours...');
      } catch (error) {
        // Expected - connection will be lost during reboot
      }
    }

    function showStatus(type, message) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.className = 'status-message visible ' + type;
      statusEl.textContent = message;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
